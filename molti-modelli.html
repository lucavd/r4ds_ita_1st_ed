<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>25 Molti modelli | R for Data Science - edizione italiana</title>
<meta name="author" content="Hadley Wickham e Garrett Grolemund">
<meta name="description" content="25.1 Introduzione In questo capitolo imparerete tre potenti idee che vi aiuteranno a lavorare con un gran numero di modelli con facilità: Usare molti modelli semplici per capire meglio insiemi di...">
<meta name="generator" content="bookdown 0.28.2 with bs4_book()">
<meta property="og:title" content="25 Molti modelli | R for Data Science - edizione italiana">
<meta property="og:type" content="book">
<meta property="og:url" content="http://it.r4ds.hadley.nz/molti-modelli.html">
<meta property="og:image" content="http://it.r4ds.hadley.nz/cover.png">
<meta property="og:description" content="25.1 Introduzione In questo capitolo imparerete tre potenti idee che vi aiuteranno a lavorare con un gran numero di modelli con facilità: Usare molti modelli semplici per capire meglio insiemi di...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="25 Molti modelli | R for Data Science - edizione italiana">
<meta name="twitter:site" content="@lucavd">
<meta name="twitter:description" content="25.1 Introduzione In questo capitolo imparerete tre potenti idee che vi aiuteranno a lavorare con un gran numero di modelli con facilità: Usare molti modelli semplici per capire meglio insiemi di...">
<meta name="twitter:image" content="http://it.r4ds.hadley.nz/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.0.9000/transition.js"></script><script src="libs/bs3compat-0.4.0.9000/tabs.js"></script><script src="libs/bs3compat-0.4.0.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/str_view-0.1.0/str_view.css" rel="stylesheet">
<script src="libs/str_view-binding-1.4.0/str_view.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'UA-115082821-1');
  </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R for Data Science - edizione italiana</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Benvenuto</a></li>
<li><a class="" href="introduzione.html"><span class="header-section-number">1</span> Introduzione</a></li>
<li class="book-part">Esplora</li>
<li><a class="" href="explore-intro.html"><span class="header-section-number">2</span> Introduzione</a></li>
<li><a class="" href="visualizzazione.html"><span class="header-section-number">3</span> Visualizzazione</a></li>
<li><a class="" href="workflow-basi.html"><span class="header-section-number">4</span> Workflow: basi</a></li>
<li><a class="" href="transform.html"><span class="header-section-number">5</span> Trasformazione</a></li>
<li><a class="" href="workflow-script.html"><span class="header-section-number">6</span> Workflow: script</a></li>
<li><a class="" href="analisi-esplorativa.html"><span class="header-section-number">7</span> Analisi esplorativa</a></li>
<li><a class="" href="workflow-progetti.html"><span class="header-section-number">8</span> Workflow: progetti</a></li>
<li class="book-part">Wrangle</li>
<li><a class="" href="wrangle-intro.html"><span class="header-section-number">9</span> Introduzione</a></li>
<li><a class="" href="tibble.html"><span class="header-section-number">10</span> Tibble</a></li>
<li><a class="" href="importazione-dei-dati.html"><span class="header-section-number">11</span> Importazione dei dati</a></li>
<li><a class="" href="tidy-data.html"><span class="header-section-number">12</span> Tidy data</a></li>
<li><a class="" href="dati-relazionali.html"><span class="header-section-number">13</span> Dati relazionali</a></li>
<li><a class="" href="stringhe.html"><span class="header-section-number">14</span> Stringhe</a></li>
<li><a class="" href="fattori.html"><span class="header-section-number">15</span> Fattori</a></li>
<li><a class="" href="date-e-tempi.html"><span class="header-section-number">16</span> Date e tempi</a></li>
<li class="book-part">Programmare</li>
<li><a class="" href="program-intro.html"><span class="header-section-number">17</span> Introduzione</a></li>
<li><a class="" href="pipe.html"><span class="header-section-number">18</span> Pipe</a></li>
<li><a class="" href="funzioni.html"><span class="header-section-number">19</span> Funzioni</a></li>
<li><a class="" href="vettori.html"><span class="header-section-number">20</span> Vettori</a></li>
<li><a class="" href="iterazioni.html"><span class="header-section-number">21</span> Iterazioni</a></li>
<li class="book-part">Model</li>
<li><a class="" href="model-intro.html"><span class="header-section-number">22</span> Introduzione</a></li>
<li><a class="" href="modelli-base.html"><span class="header-section-number">23</span> Modelli base</a></li>
<li><a class="" href="costruire-modelli.html"><span class="header-section-number">24</span> Costruire modelli</a></li>
<li><a class="active" href="molti-modelli.html"><span class="header-section-number">25</span> Molti modelli</a></li>
<li class="book-part">Comunicare</li>
<li><a class="" href="communicate-intro.html"><span class="header-section-number">26</span> Introduzione</a></li>
<li><a class="" href="r-markdown.html"><span class="header-section-number">27</span> R Markdown</a></li>
<li><a class="" href="grafici-per-la-comunicazione.html"><span class="header-section-number">28</span> Grafici per la comunicazione</a></li>
<li><a class="" href="formati-di-r-markdown.html"><span class="header-section-number">29</span> Formati di R Markdown</a></li>
<li><a class="" href="r-markdown-workflow.html"><span class="header-section-number">30</span> R Markdown workflow</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/lucavd/r4ds_ita_1st_ed">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="molti-modelli" class="section level1">
<h1>
<span class="header-section-number">25</span> Molti modelli<a class="anchor" aria-label="anchor" href="#molti-modelli"><i class="fas fa-link"></i></a>
</h1>
<div id="introduzione-17" class="section level2">
<h2>
<span class="header-section-number">25.1</span> Introduzione<a class="anchor" aria-label="anchor" href="#introduzione-17"><i class="fas fa-link"></i></a>
</h2>
<p>In questo capitolo imparerete tre potenti idee che vi aiuteranno a lavorare con un gran numero di modelli con facilità:</p>
<ol style="list-style-type: decimal">
<li><p>Usare molti modelli semplici per capire meglio insiemi di dati complessi.</p></li>
<li><p>Usare liste-colonne per memorizzare strutture di dati arbitrarie in un frame di dati.
Per esempio, questo vi permetterà di avere una colonna che contiene modelli
modelli lineari.</p></li>
<li><p>Usare il pacchetto <strong>broom</strong>, di David Robinson, per trasformare i modelli in dati
dati ordinati. Questa è una tecnica potente per lavorare con un gran numero di modelli
perché una volta che avete dati ordinati, potete applicare tutte le tecniche che
avete imparato in precedenza nel libro.</p></li>
</ol>
<p>Inizieremo con un esempio motivante utilizzando i dati sull’aspettativa di vita nel mondo. Si tratta di un piccolo set di dati, ma illustra quanto sia importante la modellazione per migliorare le vostre visualizzazioni. Useremo un gran numero di modelli semplici per separare alcuni dei segnali più forti in modo da poter vedere i segnali più sottili che rimangono. Vedremo anche come le sintesi dei modelli possono aiutarci a individuare i valori anomali e le tendenze insolite.</p>
<p>Le sezioni seguenti si immergeranno in maggiori dettagli sulle singole tecniche:</p>
<ol style="list-style-type: decimal">
<li><p>In <a href="molti-modelli.html#list-columns-1">list-columns</a>, imparerai di più sulla struttura dati list-columns (‘colonne-elenco’),
e perché ha senso mettere le liste nei frame di dati.</p></li>
<li><p>In [creare list-columns], imparerai i tre modi principali in cui
creare liste-colonne.</p></li>
<li><p>In <a href="molti-modelli.html#semplificare-le-list-columns">semplificare le list-columns</a> imparerai come convertire le list-columns
in vettori atomici regolari (o insiemi di vettori atomici) in modo da poter lavorare
con loro più facilmente.</p></li>
<li><p>In <a href="molti-modelli.html#rendere-ordinati-i-dati-con-broom">rendere ordinati i dati con broom</a>, imparerai a conoscere il set completo di strumenti
forniti da broom e vedrai come possono essere applicati ad altri tipi di
strutture dati.</p></li>
</ol>
<p>Questo capitolo è in qualche modo aspirazionale: se questo libro è la vostra prima introduzione a R, questo capitolo sarà probabilmente una lotta. Richiede che abbiate idee profondamente interiorizzate su modellazione, strutture di dati e iterazione. Quindi non preoccupatevi se non lo capite — mettete da parte questo capitolo per qualche mese, e tornate quando vorrete ampliare il vostro cervello.</p>
<div id="prerequisiti-17" class="section level3">
<h3>
<span class="header-section-number">25.1.1</span> Prerequisiti<a class="anchor" aria-label="anchor" href="#prerequisiti-17"><i class="fas fa-link"></i></a>
</h3>
<p>Lavorare con molti modelli richiede molti dei pacchetti del tidyverse (per l’esplorazione dei dati, il wrangling e la programmazione) e modelr per facilitare la modellazione.</p>
<div class="sourceCode" id="cb680"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://modelr.tidyverse.org">modelr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="gapminder" class="section level2">
<h2>
<span class="header-section-number">25.2</span> gapminder<a class="anchor" aria-label="anchor" href="#gapminder"><i class="fas fa-link"></i></a>
</h2>
<p>Per motivare la potenza di molti modelli semplici, esamineremo i dati “gapminder”. Questi dati sono stati resi popolari da Hans Rosling, un medico e statistico svedese. Se non avete mai sentito parlare di lui, smettete subito di leggere questo capitolo e andate a guardare uno dei suoi video! È un fantastico presentatore di dati e illustra come è possibile utilizzare i dati per presentare una storia convincente. Un buon punto di partenza è questo breve video girato insieme alla BBC: <a href="https://www.youtube.com/watch?v=jbkSRLYSojo" class="uri">https://www.youtube.com/watch?v=jbkSRLYSojo</a>.</p>
<p>I dati di gapminder riassumono la progressione dei paesi nel tempo, guardando statistiche come l’aspettativa di vita e il PIL. I dati sono facilmente accessibili in R, grazie a Jenny Bryan che ha creato il pacchetto gapminder:</p>
<div class="sourceCode" id="cb681"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder">gapminder</a></span><span class="op">)</span></span>
<span><span class="va">gapminder</span></span>
<span><span class="co">#&gt; # A tibble: 1,704 × 6</span></span>
<span><span class="co">#&gt;   country     continent  year lifeExp      pop gdpPercap</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia       1952    28.8  8425333      779.</span></span>
<span><span class="co">#&gt; 2 Afghanistan Asia       1957    30.3  9240934      821.</span></span>
<span><span class="co">#&gt; 3 Afghanistan Asia       1962    32.0 10267083      853.</span></span>
<span><span class="co">#&gt; 4 Afghanistan Asia       1967    34.0 11537966      836.</span></span>
<span><span class="co">#&gt; 5 Afghanistan Asia       1972    36.1 13079460      740.</span></span>
<span><span class="co">#&gt; 6 Afghanistan Asia       1977    38.4 14880372      786.</span></span>
<span><span class="co">#&gt; # … with 1,698 more rows</span></span></code></pre></div>
<p>In questo caso di studio, ci concentreremo solo su tre variabili per rispondere alla domanda "Come cambia l’aspettativa di vita (<code>lifeExp</code>) nel tempo (<code>year</code>) per ogni paese (<code>country</code>)? Un buon punto di partenza è un grafico:</p>
<div class="sourceCode" id="cb682"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">lifeExp</span>, group <span class="op">=</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="model-many_files/figure-html/unnamed-chunk-2-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Questo è un piccolo dataset: ha solo ~1.700 osservazioni e 3 variabili. Ma è ancora difficile vedere cosa sta succedendo! Nel complesso, sembra che l’aspettativa di vita sia migliorata costantemente. Tuttavia, se si guarda da vicino, si possono notare alcuni paesi che non seguono questo schema. Come possiamo rendere questi paesi più facili da vedere?</p>
<p>Un modo è usare lo stesso approccio dell’ultimo capitolo: c’è un segnale forte (la crescita lineare complessiva) che rende difficile vedere tendenze più sottili. Distingueremo questi fattori adattando un modello con una tendenza lineare. Il modello cattura la crescita costante nel tempo, e i residui mostreranno ciò che rimane.</p>
<p>Sapete già come farlo se avessimo un singolo paese:</p>
<div class="sourceCode" id="cb683"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gapminder</span>, <span class="va">country</span> <span class="op">==</span> <span class="st">"New Zealand"</span><span class="op">)</span></span>
<span><span class="va">nz</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">lifeExp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Full data = "</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nz_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">nz</span><span class="op">)</span></span>
<span><span class="va">nz</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://modelr.tidyverse.org/reference/add_predictions.html">add_predictions</a></span><span class="op">(</span><span class="va">nz_mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">pred</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Linear trend + "</span><span class="op">)</span></span>
<span></span>
<span><span class="va">nz</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://modelr.tidyverse.org/reference/add_residuals.html">add_residuals</a></span><span class="op">(</span><span class="va">nz_mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, colour <span class="op">=</span> <span class="st">"white"</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Remaining pattern"</span><span class="op">)</span></span></code></pre></div>
<p><img src="model-many_files/figure-html/unnamed-chunk-3-1.png" width="33%"><img src="model-many_files/figure-html/unnamed-chunk-3-2.png" width="33%"><img src="model-many_files/figure-html/unnamed-chunk-3-3.png" width="33%"></p>
<p>Come possiamo facilmente adattare questo modello ad ogni paese?</p>
<div id="dati-annidati" class="section level3">
<h3>
<span class="header-section-number">25.2.1</span> Dati annidati<a class="anchor" aria-label="anchor" href="#dati-annidati"><i class="fas fa-link"></i></a>
</h3>
<p>Potresti immaginare di copiare e incollare quel codice più volte; ma hai già imparato un modo migliore! Estrai il codice comune con una funzione e ripeti usando una funzione di mappa da purrr. Questo problema è strutturato un po’ diversamente da quello che hai visto prima. Invece di ripetere un’azione per ogni variabile, vogliamo ripetere un’azione per ogni paese, un sottoinsieme di righe. Per farlo, abbiamo bisogno di una nuova struttura di dati: il <strong>data frame annidato</strong> (nested data frame). Per creare un data frame annidato, iniziamo con un data frame raggruppato e lo annidiamo:</p>
<div class="sourceCode" id="cb684"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_country</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">continent</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">by_country</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 3</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data             </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           </span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; # … with 136 more rows</span></span></code></pre></div>
<p>(Sto imbrogliando un po’ raggruppando sia il <code>continent</code> che il <code>country</code>. Dato il <code>country</code>, il <code>continente</code> è fisso, quindi questo non aggiunge altri gruppi, ma è un modo semplice per portare con sé una variabile extra).</p>
<p>Questo crea un frame di dati che ha una riga per gruppo (per paese) e una colonna piuttosto insolita: <code>data</code>. <code>data</code> è una lista di data frame (o tibbie, per essere precisi). Sembra un’idea folle: abbiamo un data frame con una colonna che è una lista di altri data frame! Spiegherò brevemente perché penso che sia una buona idea.</p>
<p>La colonna <code>data</code> è un po’ difficile da guardare perché è una lista moderatamente complicata, e stiamo ancora lavorando su buoni strumenti per esplorare questi oggetti. Sfortunatamente l’uso di <code><a href="https://rdrr.io/r/utils/str.html">str()</a></code> non è raccomandato perché spesso produce un output molto lungo. Ma se si estrae un singolo elemento dalla colonna <code>data</code> si vedrà che contiene tutti i dati per quel paese (in questo caso, Afghanistan).</p>
<div class="sourceCode" id="cb685"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_country</span><span class="op">$</span><span class="va">data</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 4</span></span>
<span><span class="co">#&gt;    year lifeExp      pop gdpPercap</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  1952    28.8  8425333      779.</span></span>
<span><span class="co">#&gt; 2  1957    30.3  9240934      821.</span></span>
<span><span class="co">#&gt; 3  1962    32.0 10267083      853.</span></span>
<span><span class="co">#&gt; 4  1967    34.0 11537966      836.</span></span>
<span><span class="co">#&gt; 5  1972    36.1 13079460      740.</span></span>
<span><span class="co">#&gt; 6  1977    38.4 14880372      786.</span></span>
<span><span class="co">#&gt; # … with 6 more rows</span></span></code></pre></div>
<p>Notate la differenza tra un data frame standard raggruppato e un data frame annidato: in un data frame raggruppato, ogni riga è un’osservazione; in un data frame annidato, ogni riga è un gruppo. Un altro modo di pensare a un dataset annidato è che ora abbiamo una meta-osservazione: una riga che rappresenta l’intero corso del tempo per un paese, piuttosto che un singolo punto nel tempo.</p>
</div>
<div id="list-columns" class="section level3">
<h3>
<span class="header-section-number">25.2.2</span> List-columns<a class="anchor" aria-label="anchor" href="#list-columns"><i class="fas fa-link"></i></a>
</h3>
<p>Ora che abbiamo il nostro dataset annidato, siamo in una buona posizione per adattare alcuni modelli. Abbiamo una funzione di adattamento del modello:</p>
<div class="sourceCode" id="cb686"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">country_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">~</span> <span class="va">year</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>E vogliamo applicarlo ad ogni frame di dati. I frame di dati sono in una lista, quindi possiamo usare <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code> per applicare <code>country_model</code> ad ogni elemento:</p>
<div class="sourceCode" id="cb687"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">by_country</span><span class="op">$</span><span class="va">data</span>, <span class="va">country_model</span><span class="op">)</span></span></code></pre></div>
<p>Tuttavia, piuttosto che lasciare l’elenco dei modelli come un oggetto fluttuante, penso che sia meglio memorizzarlo come una colonna nel frame di dati <code>by_country</code>. Memorizzare oggetti correlati in colonne è una parte fondamentale del valore dei data frame, e il motivo per cui penso che le colonne-elenco siano una buona idea. Nel corso del lavoro con questi paesi, avremo molte liste dove abbiamo un elemento per paese. Quindi perché non memorizzarli tutti insieme in un unico frame di dati?</p>
<p>In altre parole, invece di creare un nuovo oggetto nell’ambiente globale, creeremo una nuova variabile nel data frame <code>by_country</code>. Questo è un lavoro per <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code>:</p>
<div class="sourceCode" id="cb688"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_country</span> <span class="op">&lt;-</span> <span class="va">by_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">country_model</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">by_country</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 4</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data              model </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; # … with 136 more rows</span></span></code></pre></div>
<p>Questo ha un grande vantaggio: poiché tutti gli oggetti correlati sono memorizzati insieme, non è necessario mantenerli manualmente sincronizzati quando si filtra o si organizza. La semantica del data frame se ne occupa per voi:</p>
<div class="sourceCode" id="cb689"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">==</span> <span class="st">"Europe"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 30 × 4</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [30]</span></span>
<span><span class="co">#&gt;   country                continent data              model </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;                  &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1 Albania                Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 2 Austria                Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 3 Belgium                Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 4 Bosnia and Herzegovina Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 5 Bulgaria               Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 6 Croatia                Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; # … with 24 more rows</span></span>
<span><span class="va">by_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">continent</span>, <span class="va">country</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 4</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country      continent data              model </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;        &lt;fct&gt;     &lt;list&gt;            &lt;list&gt;</span></span>
<span><span class="co">#&gt; 1 Algeria      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 2 Angola       Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 3 Benin        Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 4 Botswana     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 5 Burkina Faso Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; 6 Burundi      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;  </span></span>
<span><span class="co">#&gt; # … with 136 more rows</span></span></code></pre></div>
<p>Se la vostra lista di data frame e la lista di modelli fossero oggetti separati, dovete ricordarvi che ogni volta che riordinate o sotto-ordinate un vettore, dovete ri-ordinare o sotto-ordinare tutti gli altri per tenerli sincronizzati. Se lo dimenticate, il vostro codice continuerà a funzionare, ma darà la risposta sbagliata!</p>
</div>
<div id="disannidare-unnesting" class="section level3">
<h3>
<span class="header-section-number">25.2.3</span> Disannidare (unnesting)<a class="anchor" aria-label="anchor" href="#disannidare-unnesting"><i class="fas fa-link"></i></a>
</h3>
<p>In precedenza abbiamo calcolato i residui di un singolo modello con un singolo set di dati. Ora abbiamo 142 frame di dati e 142 modelli. Per calcolare i residui, dobbiamo chiamare <code><a href="https://modelr.tidyverse.org/reference/add_residuals.html">add_residuals()</a></code> con ogni coppia modello-dati:</p>
<div class="sourceCode" id="cb690"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_country</span> <span class="op">&lt;-</span> <span class="va">by_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    resids <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">model</span>, <span class="va">add_residuals</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">by_country</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 5</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data              model  resids           </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;            &lt;list&gt; &lt;list&gt;           </span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [12 × 5]&gt;</span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [12 × 5]&gt;</span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [12 × 5]&gt;</span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [12 × 5]&gt;</span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [12 × 5]&gt;</span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [12 × 5]&gt;</span></span>
<span><span class="co">#&gt; # … with 136 more rows</span></span></code></pre></div>
<p>Ma come si può tracciare una lista di frame di dati? Invece di lottare per rispondere a questa domanda, trasformiamo di nuovo la lista di data frame in un normale data frame. In precedenza abbiamo usato <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> per trasformare un data frame regolare in un data frame annidato, e ora facciamo il contrario con <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code>:</p>
<div class="sourceCode" id="cb691"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">by_country</span>, <span class="va">resids</span><span class="op">)</span></span>
<span><span class="va">resids</span></span>
<span><span class="co">#&gt; # A tibble: 1,704 × 9</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data     model   year lifeExp      pop gdpPercap   resid</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;   &lt;list&gt; &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;    1952    28.8  8425333      779. -1.11  </span></span>
<span><span class="co">#&gt; 2 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;    1957    30.3  9240934      821. -0.952 </span></span>
<span><span class="co">#&gt; 3 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;    1962    32.0 10267083      853. -0.664 </span></span>
<span><span class="co">#&gt; 4 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;    1967    34.0 11537966      836. -0.0172</span></span>
<span><span class="co">#&gt; 5 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;    1972    36.1 13079460      740.  0.674 </span></span>
<span><span class="co">#&gt; 6 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;    1977    38.4 14880372      786.  1.65  </span></span>
<span><span class="co">#&gt; # … with 1,698 more rows</span></span></code></pre></div>
<p>Si noti che ogni colonna regolare è ripetuta una volta per ogni riga della tibla annidata.</p>
<p>Ora che abbiamo una struttura di dati regolare, possiamo tracciare i residui:</p>
<div class="sourceCode" id="cb692"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resids</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">country</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</span></span></code></pre></div>
<div class="inline-figure"><img src="model-many_files/figure-html/unnamed-chunk-12-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>La sfaccettatura per continente è particolarmente rivelatrice:</p>
<div class="sourceCode" id="cb693"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resids</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">resid</span>, group <span class="op">=</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span> <span class="op">/</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">continent</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="model-many_files/figure-html/unnamed-chunk-13-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Sembra che ci siamo persi alcuni schemi leggeri. C’è anche qualcosa di interessante in Africa: vediamo alcuni residui molto grandi che suggeriscono che il nostro modello non si adatta così bene lì. Esploreremo meglio questo aspetto nella prossima sezione, attaccandolo da un’angolazione leggermente diversa.</p>
</div>
<div id="qualità-del-modello" class="section level3">
<h3>
<span class="header-section-number">25.2.4</span> Qualità del modello<a class="anchor" aria-label="anchor" href="#qualit%C3%A0-del-modello"><i class="fas fa-link"></i></a>
</h3>
<p>Invece di guardare i residui del modello, potremmo guardare alcune misure generali della qualità del modello. Avete imparato come calcolare alcune misure specifiche nel capitolo precedente. Qui mostreremo un approccio diverso usando il pacchetto broom. Il pacchetto broom fornisce un insieme generale di funzioni per trasformare i modelli in dati ordinati. Qui useremo <code><a href="https://generics.r-lib.org/reference/glance.html">broom::glance()</a></code> per estrarre alcune metriche di qualità del modello. Se lo applichiamo a un modello, otteniamo un frame di dati con una sola riga:</p>
<div class="sourceCode" id="cb694"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">(</span><span class="va">nz_mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 12</span></span>
<span><span class="co">#&gt;   r.squared adj.r.squared sigma statistic      p.value    df logLik   AIC   BIC</span></span>
<span><span class="co">#&gt;       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     0.954         0.949 0.804      205. 0.0000000541     1  -13.3  32.6  34.1</span></span>
<span><span class="co">#&gt; # … with 3 more variables: deviance &lt;dbl&gt;, df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code></pre></div>
<p>Possiamo usare <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> e <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> per creare un frame di dati con una riga per ogni paese:</p>
<div class="sourceCode" id="cb695"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>glance <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">glance</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 17</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data     model  resids   r.squared adj.r.squared sigma</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;   &lt;list&gt; &lt;list&gt;       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.948         0.942 1.22 </span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.911         0.902 1.98 </span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.985         0.984 1.32 </span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.888         0.877 1.41 </span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.996         0.995 0.292</span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.980         0.978 0.621</span></span>
<span><span class="co">#&gt; # … with 136 more rows, and 9 more variables: statistic &lt;dbl&gt;, p.value &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   df &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code></pre></div>
<p>Questo non è esattamente l’output che vogliamo, perché include ancora tutte le colonne della lista. Questo è il comportamento predefinito quando <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> lavora su frame di dati a riga singola. Per sopprimere queste colonne usiamo <code>.drop = TRUE</code>:</p>
<div class="sourceCode" id="cb696"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glance</span> <span class="op">&lt;-</span> <span class="va">by_country</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>glance <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu">broom</span><span class="fu">::</span><span class="va"><a href="https://generics.r-lib.org/reference/glance.html">glance</a></span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">glance</span>, .drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: The `.drop` argument of `unnest()` is deprecated as of tidyr 1.0.0.</span></span>
<span><span class="co">#&gt; All list-columns are now preserved.</span></span>
<span><span class="co">#&gt; This warning is displayed once every 8 hours.</span></span>
<span><span class="co">#&gt; Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</span></span>
<span><span class="va">glance</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 17</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data     model  resids   r.squared adj.r.squared sigma</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;   &lt;list&gt; &lt;list&gt;       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.948         0.942 1.22 </span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.911         0.902 1.98 </span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.985         0.984 1.32 </span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.888         0.877 1.41 </span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.996         0.995 0.292</span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;     0.980         0.978 0.621</span></span>
<span><span class="co">#&gt; # … with 136 more rows, and 9 more variables: statistic &lt;dbl&gt;, p.value &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   df &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code></pre></div>
<p>(Fate attenzione alle variabili che non sono stampate: c’è un sacco di roba utile lì).</p>
<p>Con questo quadro di dati in mano, possiamo iniziare a cercare i modelli che non si adattano bene:</p>
<div class="sourceCode" id="cb697"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">r.squared</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 17</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country   continent data     model  resids   r.squared adj.r.squared sigma</span></span>
<span><span class="co">#&gt;   &lt;fct&gt;     &lt;fct&gt;     &lt;list&gt;   &lt;list&gt; &lt;list&gt;       &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 Rwanda    Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;    0.0172      -0.0811   6.56</span></span>
<span><span class="co">#&gt; 2 Botswana  Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;    0.0340      -0.0626   6.11</span></span>
<span><span class="co">#&gt; 3 Zimbabwe  Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;    0.0562      -0.0381   7.21</span></span>
<span><span class="co">#&gt; 4 Zambia    Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;    0.0598      -0.0342   4.53</span></span>
<span><span class="co">#&gt; 5 Swaziland Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;    0.0682      -0.0250   6.64</span></span>
<span><span class="co">#&gt; 6 Lesotho   Africa    &lt;tibble&gt; &lt;lm&gt;   &lt;tibble&gt;    0.0849      -0.00666  5.93</span></span>
<span><span class="co">#&gt; # … with 136 more rows, and 9 more variables: statistic &lt;dbl&gt;, p.value &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   df &lt;dbl&gt;, logLik &lt;dbl&gt;, AIC &lt;dbl&gt;, BIC &lt;dbl&gt;, deviance &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   df.residual &lt;int&gt;, nobs &lt;int&gt;</span></span></code></pre></div>
<p>I modelli peggiori sembrano essere tutti in Africa. Ricontrolliamo questo con un grafico. Qui abbiamo un numero relativamente piccolo di osservazioni e una variabile discreta, quindi <code><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter()</a></code> è efficace:</p>
<div class="sourceCode" id="cb698"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glance</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">continent</span>, <span class="va">r.squared</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="model-many_files/figure-html/unnamed-chunk-18-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Potremmo estrarre i paesi con <span class="math inline">\(R^2\)</span> particolarmente cattivi e tracciare i dati:</p>
<div class="sourceCode" id="cb699"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bad_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">glance</span>, <span class="va">r.squared</span> <span class="op">&lt;</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">bad_fit</span>, by <span class="op">=</span> <span class="st">"country"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">lifeExp</span>, colour <span class="op">=</span> <span class="va">country</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="model-many_files/figure-html/unnamed-chunk-19-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Qui vediamo due effetti principali: le tragedie dell’epidemia di HIV/AIDS e il genocidio del Ruanda.</p>
</div>
<div id="esercizi-68" class="section level3">
<h3>
<span class="header-section-number">25.2.5</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-68"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Una tendenza lineare sembra essere un po’ troppo semplice per la tendenza generale.
Puoi fare meglio con un polinomio quadratico? Come potete interpretare
i coefficienti della quadratica? (Suggerimento: potreste voler trasformare
anno` in modo che abbia media zero).</p></li>
<li><p>Esplorate altri metodi per visualizzare la distribuzione di <span class="math inline">\(R^2\)</span> per
continente. Potreste provare il pacchetto ggbeeswarm, che fornisce
metodi simili per evitare sovrapposizioni come il jitter, ma usa metodi deterministici
deterministici.</p></li>
<li><p>Per creare l’ultimo grafico (che mostra i dati per i paesi con il
peggiori modelli di adattamento), abbiamo avuto bisogno di due passaggi: abbiamo creato un frame di dati con
una riga per paese e poi lo abbiamo semi-unito al dataset originale.
È possibile evitare questa unione se usiamo <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> invece di
<code>unnest(.drop = TRUE)</code>. Come?</p></li>
</ol>
</div>
</div>
<div id="list-columns-1" class="section level2">
<h2>
<span class="header-section-number">25.3</span> List-columns<a class="anchor" aria-label="anchor" href="#list-columns-1"><i class="fas fa-link"></i></a>
</h2>
<p>Ora che avete visto un flusso di lavoro di base per la gestione di molti modelli, rituffiamoci in alcuni dettagli. In questa sezione, esploreremo la struttura dati delle liste-colonne un po’ più in dettaglio. È solo di recente che ho veramente apprezzato l’idea della colonna-elenco. Le liste-colonne sono implicite nella definizione del data frame: un data frame è una lista nominata di vettori di uguale lunghezza. Una lista è un vettore, quindi è sempre stato legittimo usare una lista come colonna di un data frame. Tuttavia, R di base non rende facile la creazione di liste-colonne, e <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> tratta una lista come una lista di colonne:.</p>
<div class="sourceCode" id="cb700"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;   x.1.3 x.3.5</span></span>
<span><span class="co">#&gt; 1     1     3</span></span>
<span><span class="co">#&gt; 2     2     4</span></span>
<span><span class="co">#&gt; 3     3     5</span></span></code></pre></div>
<p>Potete evitare che <code><a href="https://rdrr.io/r/base/data.frame.html">data.frame()</a></code> faccia questo con <code><a href="https://rdrr.io/r/base/AsIs.html">I()</a></code>, ma il risultato non viene stampato particolarmente bene:</p>
<div class="sourceCode" id="cb701"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1, 2"</span>, <span class="st">"3, 4, 5"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;         x       y</span></span>
<span><span class="co">#&gt; 1 1, 2, 3    1, 2</span></span>
<span><span class="co">#&gt; 2 3, 4, 5 3, 4, 5</span></span></code></pre></div>
<p>Tibble allevia questo problema essendo più pigro (<code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code> non modifica i suoi input) e fornendo un metodo di stampa migliore:</p>
<div class="sourceCode" id="cb702"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, </span>
<span>  y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"1, 2"</span>, <span class="st">"3, 4, 5"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   x         y      </span></span>
<span><span class="co">#&gt;   &lt;list&gt;    &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 &lt;int [3]&gt; 1, 2   </span></span>
<span><span class="co">#&gt; 2 &lt;int [3]&gt; 3, 4, 5</span></span></code></pre></div>
<p>È ancora più facile con <code><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble()</a></code> in quanto può capire automaticamente che avete bisogno di una lista:</p>
<div class="sourceCode" id="cb703"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>   <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,</span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>, <span class="st">"1, 2"</span>,</span>
<span>  <span class="fl">3</span><span class="op">:</span><span class="fl">5</span>, <span class="st">"3, 4, 5"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   x         y      </span></span>
<span><span class="co">#&gt;   &lt;list&gt;    &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1 &lt;int [3]&gt; 1, 2   </span></span>
<span><span class="co">#&gt; 2 &lt;int [3]&gt; 3, 4, 5</span></span></code></pre></div>
<p>Le colonne-elenco sono spesso molto utili come struttura dati intermedia. Sono difficili da lavorare direttamente, perché la maggior parte delle funzioni di R lavora con vettori atomici o frame di dati, ma il vantaggio di tenere insieme elementi correlati in un frame di dati vale un po’ di fastidio.</p>
<p>Generalmente ci sono tre parti di una efficace pipeline lista-colonna:</p>
<ol style="list-style-type: decimal">
<li><p>Si crea la lista-colonna usando uno dei metodi <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> + <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>,
o <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> + una funzione di mappa, come descritto in [Creare liste-colonne].</p></li>
<li><p>Si creano altre colonne-elenco intermedie trasformando le colonne-elenco esistenti con
colonne della lista con <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2()</a></code> o <code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap()</a></code>. Per esempio,
nel caso di studio precedente, abbiamo creato una lista-colonna di modelli trasformando
una colonna-elenco di frame di dati.</p></li>
<li><p>Si semplifica la lista-colonna riducendola a un data frame o a un vettore atomico,
come descritto in [Simplifying list-columns].</p></li>
</ol>
</div>
<div id="creazione-di-list-columns" class="section level2">
<h2>
<span class="header-section-number">25.4</span> Creazione di list-columns<a class="anchor" aria-label="anchor" href="#creazione-di-list-columns"><i class="fas fa-link"></i></a>
</h2>
<p>Tipicamente, non si creano colonne-elenco con <code><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble()</a></code>. Invece, le creerai da colonne regolari, usando uno dei tre metodi:</p>
<ol style="list-style-type: decimal">
<li><p>Con <code><a href="https://tidyr.tidyverse.org/reference/nest.html">tidyr::nest()</a></code> per convertire un data frame raggruppato in un data frame annidato
in un frame di dati annidato in cui si ha una lista-colonna di frame di dati.</p></li>
<li><ol start="2" style="list-style-type: decimal">
<li>Con <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> e funzioni vettoriali che restituiscono una lista.</li>
</ol></li>
<li><p>Con <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> e le funzioni di riepilogo che restituiscono più risultati.</p></li>
</ol>
<p>In alternativa, potreste crearli da una lista nominata, usando <code><a href="https://tibble.tidyverse.org/reference/enframe.html">tibble::enframe()</a></code>.</p>
<p>Generalmente, quando si creano colonne di liste, ci si dovrebbe assicurare che siano omogenee: ogni elemento dovrebbe contenere lo stesso tipo di cose. Non ci sono controlli per assicurarsi che questo sia vero, ma se usate purrr e ricordate ciò che avete imparato sulle funzioni type-stable, dovreste scoprire che ciò avviene naturalmente.</p>
<div id="con-lannidamento" class="section level3">
<h3>
<span class="header-section-number">25.4.1</span> Con l’annidamento<a class="anchor" aria-label="anchor" href="#con-lannidamento"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> crea un data frame annidato, che è un data frame con una lista-colonna di data frame. In un data frame annidato ogni riga è una meta-osservazione: le altre colonne danno le variabili che definiscono l’osservazione (come il paese e il continente sopra), e la lista-colonna di data frame dà le singole osservazioni che compongono la meta-osservazione.</p>
<p>Ci sono due modi per usare <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code>. Finora avete visto come usarlo con un frame di dati raggruppato. Quando viene applicato ad un frame di dati raggruppati, <code><a href="https://tidyr.tidyverse.org/reference/nest.html">nest()</a></code> mantiene le colonne di raggruppamento così come sono, e raggruppa tutto il resto nella lista-colonna:</p>
<div class="sourceCode" id="cb704"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">country</span>, <span class="va">continent</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 3</span></span>
<span><span class="co">#&gt; # Groups:   country, continent [142]</span></span>
<span><span class="co">#&gt;   country     continent data             </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           </span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; # … with 136 more rows</span></span></code></pre></div>
<p>Potete anche usarlo su un frame di dati non raggruppato, specificando quali colonne volete annidare:</p>
<div class="sourceCode" id="cb705"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 142 × 3</span></span>
<span><span class="co">#&gt;   country     continent data             </span></span>
<span><span class="co">#&gt;   &lt;fct&gt;       &lt;fct&gt;     &lt;list&gt;           </span></span>
<span><span class="co">#&gt; 1 Afghanistan Asia      &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 2 Albania     Europe    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 3 Algeria     Africa    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 4 Angola      Africa    &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 5 Argentina   Americas  &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; 6 Australia   Oceania   &lt;tibble [12 × 4]&gt;</span></span>
<span><span class="co">#&gt; # … with 136 more rows</span></span></code></pre></div>
</div>
<div id="dalle-funzioni-vettoriali" class="section level3">
<h3>
<span class="header-section-number">25.4.2</span> Dalle funzioni vettoriali<a class="anchor" aria-label="anchor" href="#dalle-funzioni-vettoriali"><i class="fas fa-link"></i></a>
</h3>
<p>Alcune funzioni utili prendono un vettore atomico e restituiscono una lista. Per esempio, in [strings] avete imparato a conoscere <code><a href="https://stringr.tidyverse.org/reference/str_split.html">stringr::str_split()</a></code> che prende un vettore di caratteri e restituisce una lista di vettori di caratteri. Se lo usi dentro mutate, otterrai una lista-colonna:</p>
<div class="sourceCode" id="cb706"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x1</span>,</span>
<span>  <span class="st">"a,b,c"</span>, </span>
<span>  <span class="st">"d,e,f,g"</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x2 <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="va">x1</span>, <span class="st">","</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 2</span></span>
<span><span class="co">#&gt;   x1      x2       </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;list&gt;   </span></span>
<span><span class="co">#&gt; 1 a,b,c   &lt;chr [3]&gt;</span></span>
<span><span class="co">#&gt; 2 d,e,f,g &lt;chr [4]&gt;</span></span></code></pre></div>
<p><code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> sa come gestire queste liste di vettori:</p>
<div class="sourceCode" id="cb707"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>x2 <span class="op">=</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html">str_split</a></span><span class="op">(</span><span class="va">x1</span>, <span class="st">","</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 7 × 2</span></span>
<span><span class="co">#&gt;   x1      x2   </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 a,b,c   a    </span></span>
<span><span class="co">#&gt; 2 a,b,c   b    </span></span>
<span><span class="co">#&gt; 3 a,b,c   c    </span></span>
<span><span class="co">#&gt; 4 d,e,f,g d    </span></span>
<span><span class="co">#&gt; 5 d,e,f,g e    </span></span>
<span><span class="co">#&gt; 6 d,e,f,g f    </span></span>
<span><span class="co">#&gt; # … with 1 more row</span></span></code></pre></div>
<p>(Se vi trovate ad usare spesso questo schema, assicuratevi di controllare <code><a href="https://tidyr.tidyverse.org/reference/separate_rows.html">tidyr::separate_rows()</a></code> che è un wrapper intorno a questo schema comune).</p>
<p>Un altro esempio di questo pattern è l’uso di <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map2.html">pmap()</a></code> da purrr. Per esempio, potremmo prendere l’esempio finale da [Invoking different functions] e riscriverlo per usare <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>:</p>
<div class="sourceCode" id="cb708"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">f</span>,      <span class="op">~</span><span class="va">params</span>,</span>
<span>  <span class="st">"runif"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>min <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, max <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="st">"rnorm"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>sd <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>  <span class="st">"rpois"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sims <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/invoke.html">invoke_map</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">params</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span><span class="co">#&gt;   f     params           sims      </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;list&gt;           &lt;list&gt;    </span></span>
<span><span class="co">#&gt; 1 runif &lt;named list [2]&gt; &lt;dbl [10]&gt;</span></span>
<span><span class="co">#&gt; 2 rnorm &lt;named list [1]&gt; &lt;dbl [10]&gt;</span></span>
<span><span class="co">#&gt; 3 rpois &lt;named list [1]&gt; &lt;int [10]&gt;</span></span></code></pre></div>
<p>Notate che tecnicamente <code>sim</code> non è omogeneo perché contiene sia vettori doppi che interi. Tuttavia, è improbabile che questo causi molti problemi, dato che interi e doppi sono entrambi vettori numerici.</p>
</div>
<div id="dai-sommari-multivalutati" class="section level3">
<h3>
<span class="header-section-number">25.4.3</span> Dai sommari multivalutati<a class="anchor" aria-label="anchor" href="#dai-sommari-multivalutati"><i class="fas fa-link"></i></a>
</h3>
<p>Una restrizione di <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> è che funziona solo con funzioni di riepilogo che restituiscono un singolo valore. Ciò significa che non potete usarla con funzioni come <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> che restituiscono un vettore di lunghezza arbitraria:</p>
<div class="sourceCode" id="cb709"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'cyl'. You can override using the `.groups`</span></span>
<span><span class="co">#&gt; argument.</span></span>
<span><span class="co">#&gt; # A tibble: 15 × 2</span></span>
<span><span class="co">#&gt; # Groups:   cyl [3]</span></span>
<span><span class="co">#&gt;     cyl     q</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     4  21.4</span></span>
<span><span class="co">#&gt; 2     4  22.8</span></span>
<span><span class="co">#&gt; 3     4  26  </span></span>
<span><span class="co">#&gt; 4     4  30.4</span></span>
<span><span class="co">#&gt; 5     4  33.9</span></span>
<span><span class="co">#&gt; 6     6  17.8</span></span>
<span><span class="co">#&gt; # … with 9 more rows</span></span></code></pre></div>
<p>Potete però avvolgere il risultato in una lista! Questo obbedisce al contratto di <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>, perché ogni sommario è ora una lista (un vettore) di lunghezza 1.</p>
<div class="sourceCode" id="cb710"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 2</span></span>
<span><span class="co">#&gt;     cyl q        </span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;list&gt;   </span></span>
<span><span class="co">#&gt; 1     4 &lt;dbl [5]&gt;</span></span>
<span><span class="co">#&gt; 2     6 &lt;dbl [5]&gt;</span></span>
<span><span class="co">#&gt; 3     8 &lt;dbl [5]&gt;</span></span></code></pre></div>
<p>Per ottenere risultati utili con unnest, dovrete anche catturare le probabilità:</p>
<div class="sourceCode" id="cb711"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">0.99</span><span class="op">)</span></span>
<span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span>, q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mpg</span>, <span class="va">probs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">q</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 15 × 3</span></span>
<span><span class="co">#&gt;     cyl     p     q</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     4  0.01  21.4</span></span>
<span><span class="co">#&gt; 2     4  0.25  22.8</span></span>
<span><span class="co">#&gt; 3     4  0.5   26  </span></span>
<span><span class="co">#&gt; 4     4  0.75  30.4</span></span>
<span><span class="co">#&gt; 5     4  0.99  33.8</span></span>
<span><span class="co">#&gt; 6     6  0.01  17.8</span></span>
<span><span class="co">#&gt; # … with 9 more rows</span></span></code></pre></div>
</div>
<div id="da-un-elenco-con-nome" class="section level3">
<h3>
<span class="header-section-number">25.4.4</span> Da un elenco con nome<a class="anchor" aria-label="anchor" href="#da-un-elenco-con-nome"><i class="fas fa-link"></i></a>
</h3>
<p>I data frame con colonne di liste forniscono una soluzione ad un problema comune: cosa fare se si vuole iterare sia il contenuto di una lista che i suoi elementi? Invece di cercare di incastrare tutto in un solo oggetto, è spesso più facile fare un data frame: una colonna può contenere gli elementi, e una colonna può contenere la lista. Un modo semplice per creare un tale data frame da una lista è <code><a href="https://tibble.tidyverse.org/reference/enframe.html">tibble::enframe()</a></code>.</p>
<div class="sourceCode" id="cb712"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  a <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">3</span><span class="op">:</span><span class="fl">4</span>, </span>
<span>  c <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">6</span></span>
<span><span class="op">)</span> </span>
<span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="va">df</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 2</span></span>
<span><span class="co">#&gt;   name  value    </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;list&gt;   </span></span>
<span><span class="co">#&gt; 1 a     &lt;int [5]&gt;</span></span>
<span><span class="co">#&gt; 2 b     &lt;int [2]&gt;</span></span>
<span><span class="co">#&gt; 3 c     &lt;int [2]&gt;</span></span></code></pre></div>
<p>Il vantaggio di questa struttura è che si generalizza in modo diretto - i nomi sono utili se avete un vettore di metadati a carattere, ma non aiutano se avete altri tipi di dati, o vettori multipli.</p>
<p>Ora, se volete iterare su nomi e valori in parallelo, potete usare <code><a href="https://purrr.tidyverse.org/reference/map2.html">map2()</a></code>:</p>
<div class="sourceCode" id="cb713"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    smry <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2_chr</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">value</span>, <span class="op">~</span> <span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">": "</span>, <span class="va">.y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span><span class="co">#&gt;   name  value     smry </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;list&gt;    &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1 a     &lt;int [5]&gt; a: 1 </span></span>
<span><span class="co">#&gt; 2 b     &lt;int [2]&gt; b: 3 </span></span>
<span><span class="co">#&gt; 3 c     &lt;int [2]&gt; c: 5</span></span></code></pre></div>
</div>
<div id="esercizi-69" class="section level3">
<h3>
<span class="header-section-number">25.4.5</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-69"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Elenca tutte le funzioni che ti vengono in mente che prendono un vettore atomico e
restituire una lista.</p></li>
<li><p>Inventa utili funzioni di riepilogo che, come la <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code>, restituiscono
valori multipli.</p></li>
<li>
<p>Cosa manca nel seguente data frame? Come fa la funzione <code><a href="https://rdrr.io/r/stats/quantile.html">quantile()</a></code> a restituire
quel pezzo mancante? Perché non è utile in questo caso?</p>
<div class="sourceCode" id="cb714"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">mpg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 15 × 2</span></span>
<span><span class="co">#&gt;     cyl     q</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     4  21.4</span></span>
<span><span class="co">#&gt; 2     4  22.8</span></span>
<span><span class="co">#&gt; 3     4  26  </span></span>
<span><span class="co">#&gt; 4     4  30.4</span></span>
<span><span class="co">#&gt; 5     4  33.9</span></span>
<span><span class="co">#&gt; 6     6  17.8</span></span>
<span><span class="co">#&gt; # … with 9 more rows</span></span></code></pre></div>
</li>
<li>
<p>Cosa fa questo codice? Perché potrebbe essere utile?</p>
<div class="sourceCode" id="cb715"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mtcars</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">list</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>
</div>
<div id="semplificare-le-list-columns" class="section level2">
<h2>
<span class="header-section-number">25.5</span> Semplificare le list-columns<a class="anchor" aria-label="anchor" href="#semplificare-le-list-columns"><i class="fas fa-link"></i></a>
</h2>
<p>Per applicare le tecniche di manipolazione e visualizzazione dei dati che hai imparato in questo libro, avrai bisogno di semplificare la lista-colonna a una colonna regolare (un vettore atomico), o un insieme di colonne. La tecnica che userete per ridurla ad una struttura più semplice dipende dal fatto che vogliate un singolo valore per elemento o più valori:</p>
<ol style="list-style-type: decimal">
<li><p>Se volete un singolo valore, usate <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> con <code><a href="https://purrr.tidyverse.org/reference/map.html">map_lgl()</a></code>,
<code><a href="https://purrr.tidyverse.org/reference/map.html">map_int()</a></code>, <code><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl()</a></code>, e <code><a href="https://purrr.tidyverse.org/reference/map.html">map_chr()</a></code> per creare un vettore atomico.</p></li>
<li><p>Se volete molti valori, usate <code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> per convertire le colonne della lista
a colonne regolari, ripetendo le righe tante volte quanto necessario.</p></li>
</ol>
<p>Questi sono descritti più in dettaglio qui di seguito.</p>
<div id="da-lista-a-vettore" class="section level3">
<h3>
<span class="header-section-number">25.5.1</span> Da lista a vettore<a class="anchor" aria-label="anchor" href="#da-lista-a-vettore"><i class="fas fa-link"></i></a>
</h3>
<p>Se si può ridurre la colonna della lista ad un vettore atomico, allora sarà una colonna regolare. Per esempio, potete sempre riassumere un oggetto con il suo tipo e la sua lunghezza, quindi questo codice funzionerà indipendentemente dal tipo di colonna elenco che avete:</p>
<div class="sourceCode" id="cb716"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x</span>,</span>
<span>  <span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span>,</span>
<span>  <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span>  </span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  type <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_chr</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">typeof</span><span class="op">)</span>,</span>
<span>  length <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_int</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">length</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span><span class="co">#&gt;   x         type      length</span></span>
<span><span class="co">#&gt;   &lt;list&gt;    &lt;chr&gt;      &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 &lt;chr [5]&gt; character      5</span></span>
<span><span class="co">#&gt; 2 &lt;int [3]&gt; integer        3</span></span>
<span><span class="co">#&gt; 3 &lt;dbl [5]&gt; double         5</span></span></code></pre></div>
<p>Queste sono le stesse informazioni di base che si ottengono dal metodo di stampa predefinito di tbl, ma ora si possono usare per filtrare. Questa è una tecnica utile se avete una lista eterogenea e volete filtrare le parti che non funzionano.</p>
<p>Non dimenticate le scorciatoie <code>map_*()</code> - potete usare <code>map_chr(x, "apple")</code> per estrarre la stringa memorizzata in <code>apple</code> per ogni elemento di <code>x</code>. Questo è utile per estrarre liste annidate in colonne regolari. Usate l’argomento <code>.null</code> per fornire un valore da usare se l’elemento manca (invece di restituire <code>NULL</code>):</p>
<div class="sourceCode" id="cb717"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">2</span>, c <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>  a <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"a"</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map_dbl</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"b"</span>, .null <span class="op">=</span> <span class="cn">NA_real_</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span><span class="co">#&gt;   x                    a     b</span></span>
<span><span class="co">#&gt;   &lt;list&gt;           &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 &lt;named list [2]&gt;     1     2</span></span>
<span><span class="co">#&gt; 2 &lt;named list [2]&gt;     2    NA</span></span></code></pre></div>
</div>
<div id="unnesting" class="section level3">
<h3>
<span class="header-section-number">25.5.2</span> Unnesting<a class="anchor" aria-label="anchor" href="#unnesting"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest()</a></code> funziona ripetendo le colonne regolari una volta per ogni elemento della lista-colonna. Per esempio, nel seguente esempio molto semplice ripetiamo la prima riga 4 volte (perché lì il primo elemento di <code>y</code> ha lunghezza quattro), e la seconda riga una volta:</p>
<div class="sourceCode" id="cb718"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 5 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1     1</span></span>
<span><span class="co">#&gt; 2     1     2</span></span>
<span><span class="co">#&gt; 3     1     3</span></span>
<span><span class="co">#&gt; 4     1     4</span></span>
<span><span class="co">#&gt; 5     2     1</span></span></code></pre></div>
<p>Questo significa che non si può contemporaneamente snidare due colonne che contengono un numero diverso di elementi:</p>
<div class="sourceCode" id="cb719"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Ok, perché y e z hanno lo stesso numero di elementi in </span></span>
<span><span class="co"># ogni riga</span></span>
<span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,           <span class="op">~</span><span class="va">z</span>,</span>
<span>   <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,</span>
<span>   <span class="fl">2</span>, <span class="st">"c"</span>,           <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df1</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span><span class="co">#&gt;       x y         z        </span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;   </span></span>
<span><span class="co">#&gt; 1     1 &lt;chr [2]&gt; &lt;int [2]&gt;</span></span>
<span><span class="co">#&gt; 2     2 &lt;chr [1]&gt; &lt;dbl [1]&gt;</span></span>
<span><span class="va">df1</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 3</span></span>
<span><span class="co">#&gt;       x y         z</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 a         1</span></span>
<span><span class="co">#&gt; 2     1 b         2</span></span>
<span><span class="co">#&gt; 3     2 c         3</span></span>
<span></span>
<span><span class="co"># Non funziona perché y e z hanno un numero diverso di elementi</span></span>
<span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,           <span class="op">~</span><span class="va">z</span>,</span>
<span>   <span class="fl">1</span>, <span class="st">"a"</span>,         <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,  </span>
<span>   <span class="fl">2</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span>,   <span class="fl">3</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df2</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span><span class="co">#&gt;       x y         z        </span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;list&gt;    &lt;list&gt;   </span></span>
<span><span class="co">#&gt; 1     1 &lt;chr [1]&gt; &lt;int [2]&gt;</span></span>
<span><span class="co">#&gt; 2     2 &lt;chr [2]&gt; &lt;dbl [1]&gt;</span></span>
<span><span class="va">df2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">z</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span><span class="co">#&gt;       x y         z</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1 a         1</span></span>
<span><span class="co">#&gt; 2     1 a         2</span></span>
<span><span class="co">#&gt; 3     2 b         3</span></span>
<span><span class="co">#&gt; 4     2 c         3</span></span></code></pre></div>
<p>Lo stesso principio si applica quando si unnestano le colonne dell’elenco dei frame di dati. Potete unnestare più colonne-elenco finché tutti i frame di dati in ogni riga hanno lo stesso numero di righe.</p>
</div>
<div id="esercizi-70" class="section level3">
<h3>
<span class="header-section-number">25.5.3</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-70"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Perché la funzione <code><a href="https://rdrr.io/r/base/lengths.html">lengths()</a></code> potrebbe essere utile per creare colonne
colonne vettoriali da colonne-elenco?</p></li>
<li><p>Elencare i tipi più comuni di vettore che si trovano in un data frame. Cosa rende
diverse le liste?</p></li>
</ol>
</div>
</div>
<div id="rendere-ordinati-i-dati-con-broom" class="section level2">
<h2>
<span class="header-section-number">25.6</span> Rendere ordinati i dati con broom<a class="anchor" aria-label="anchor" href="#rendere-ordinati-i-dati-con-broom"><i class="fas fa-link"></i></a>
</h2>
<p>Il pacchetto broom fornisce tre strumenti generali per trasformare i modelli in frame di dati ordinati:</p>
<ol style="list-style-type: decimal">
<li><p><code>broom::glance(model)</code> restituisce una riga per ogni modello. Ogni colonna fornisce un
riepilogo del modello: o una misura della qualità del modello, o della complessità, o una
combinazione dei due.</p></li>
<li><ol style="list-style-type: decimal">
<li>
<code>broom::tidy(model)</code> restituisce una riga per ogni coefficiente nel modello. Ogni
colonna fornisce informazioni sulla stima o sulla sua variabilità.</li>
</ol></li>
<li><ol style="list-style-type: decimal">
<li>
<code>broom::augment(model, data)</code> restituisce una riga per ogni riga in <code>data</code>, aggiungendo
valori extra come i residui e le statistiche di influenza.</li>
</ol></li>
</ol>
</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="costruire-modelli.html"><span class="header-section-number">24</span> Costruire modelli</a></div>
<div class="next"><a href="communicate-intro.html"><span class="header-section-number">26</span> Introduzione</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#molti-modelli"><span class="header-section-number">25</span> Molti modelli</a></li>
<li>
<a class="nav-link" href="#introduzione-17"><span class="header-section-number">25.1</span> Introduzione</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#prerequisiti-17"><span class="header-section-number">25.1.1</span> Prerequisiti</a></li></ul>
</li>
<li>
<a class="nav-link" href="#gapminder"><span class="header-section-number">25.2</span> gapminder</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#dati-annidati"><span class="header-section-number">25.2.1</span> Dati annidati</a></li>
<li><a class="nav-link" href="#list-columns"><span class="header-section-number">25.2.2</span> List-columns</a></li>
<li><a class="nav-link" href="#disannidare-unnesting"><span class="header-section-number">25.2.3</span> Disannidare (unnesting)</a></li>
<li><a class="nav-link" href="#qualit%C3%A0-del-modello"><span class="header-section-number">25.2.4</span> Qualità del modello</a></li>
<li><a class="nav-link" href="#esercizi-68"><span class="header-section-number">25.2.5</span> Esercizi</a></li>
</ul>
</li>
<li><a class="nav-link" href="#list-columns-1"><span class="header-section-number">25.3</span> List-columns</a></li>
<li>
<a class="nav-link" href="#creazione-di-list-columns"><span class="header-section-number">25.4</span> Creazione di list-columns</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#con-lannidamento"><span class="header-section-number">25.4.1</span> Con l’annidamento</a></li>
<li><a class="nav-link" href="#dalle-funzioni-vettoriali"><span class="header-section-number">25.4.2</span> Dalle funzioni vettoriali</a></li>
<li><a class="nav-link" href="#dai-sommari-multivalutati"><span class="header-section-number">25.4.3</span> Dai sommari multivalutati</a></li>
<li><a class="nav-link" href="#da-un-elenco-con-nome"><span class="header-section-number">25.4.4</span> Da un elenco con nome</a></li>
<li><a class="nav-link" href="#esercizi-69"><span class="header-section-number">25.4.5</span> Esercizi</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#semplificare-le-list-columns"><span class="header-section-number">25.5</span> Semplificare le list-columns</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#da-lista-a-vettore"><span class="header-section-number">25.5.1</span> Da lista a vettore</a></li>
<li><a class="nav-link" href="#unnesting"><span class="header-section-number">25.5.2</span> Unnesting</a></li>
<li><a class="nav-link" href="#esercizi-70"><span class="header-section-number">25.5.3</span> Esercizi</a></li>
</ul>
</li>
<li><a class="nav-link" href="#rendere-ordinati-i-dati-con-broom"><span class="header-section-number">25.6</span> Rendere ordinati i dati con broom</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/lucavd/r4ds_ita_1st_ed/blob/master/model-many.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/lucavd/r4ds_ita_1st_ed/edit/master/model-many.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R for Data Science - edizione italiana</strong>" was written by Hadley Wickham e Garrett Grolemund. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
