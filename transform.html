<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>5 Trasformazione | R for Data Science - edizione italiana</title>
<meta name="author" content="Hadley Wickham e Garrett Grolemund">
<meta name="description" content="5.1 Introduzione La visualizzazione è uno strumento importante per la generare intuizioni, ma è raro che si ottengano i dati esattamente nella forma giusta di cui si ha bisogno. Spesso avrete...">
<meta name="generator" content="bookdown 0.31.1 with bs4_book()">
<meta property="og:title" content="5 Trasformazione | R for Data Science - edizione italiana">
<meta property="og:type" content="book">
<meta property="og:url" content="http://it.r4ds.hadley.nz/transform.html">
<meta property="og:image" content="http://it.r4ds.hadley.nz/cover.png">
<meta property="og:description" content="5.1 Introduzione La visualizzazione è uno strumento importante per la generare intuizioni, ma è raro che si ottengano i dati esattamente nella forma giusta di cui si ha bisogno. Spesso avrete...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="5 Trasformazione | R for Data Science - edizione italiana">
<meta name="twitter:site" content="@lucavd">
<meta name="twitter:description" content="5.1 Introduzione La visualizzazione è uno strumento importante per la generare intuizioni, ma è raro che si ottengano i dati esattamente nella forma giusta di cui si ha bisogno. Spesso avrete...">
<meta name="twitter:image" content="http://it.r4ds.hadley.nz/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2.9000/transition.js"></script><script src="libs/bs3compat-0.4.2.9000/tabs.js"></script><script src="libs/bs3compat-0.4.2.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="libs/str_view-0.1.0/str_view.css" rel="stylesheet">
<script src="libs/str_view-binding-1.4.1/str_view.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-115082821-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R for Data Science - edizione italiana</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Benvenuto</a></li>
<li><a class="" href="introduzione.html"><span class="header-section-number">1</span> Introduzione</a></li>
<li class="book-part">Esplora</li>
<li><a class="" href="explore-intro.html"><span class="header-section-number">2</span> Introduzione</a></li>
<li><a class="" href="visualizzazione.html"><span class="header-section-number">3</span> Visualizzazione</a></li>
<li><a class="" href="workflow-basi.html"><span class="header-section-number">4</span> Workflow: basi</a></li>
<li><a class="active" href="transform.html"><span class="header-section-number">5</span> Trasformazione</a></li>
<li><a class="" href="workflow-script.html"><span class="header-section-number">6</span> Workflow: script</a></li>
<li><a class="" href="analisi-esplorativa.html"><span class="header-section-number">7</span> Analisi esplorativa</a></li>
<li><a class="" href="workflow-progetti.html"><span class="header-section-number">8</span> Workflow: progetti</a></li>
<li class="book-part">Wrangle</li>
<li><a class="" href="wrangle-intro.html"><span class="header-section-number">9</span> Introduzione</a></li>
<li><a class="" href="tibble.html"><span class="header-section-number">10</span> Tibble</a></li>
<li><a class="" href="importazione-dei-dati.html"><span class="header-section-number">11</span> Importazione dei dati</a></li>
<li><a class="" href="tidy-data.html"><span class="header-section-number">12</span> Tidy data</a></li>
<li><a class="" href="dati-relazionali.html"><span class="header-section-number">13</span> Dati relazionali</a></li>
<li><a class="" href="stringhe.html"><span class="header-section-number">14</span> Stringhe</a></li>
<li><a class="" href="fattori.html"><span class="header-section-number">15</span> Fattori</a></li>
<li><a class="" href="date-e-tempi.html"><span class="header-section-number">16</span> Date e tempi</a></li>
<li class="book-part">Programmare</li>
<li><a class="" href="program-intro.html"><span class="header-section-number">17</span> Introduzione</a></li>
<li><a class="" href="pipe.html"><span class="header-section-number">18</span> Pipe</a></li>
<li><a class="" href="funzioni.html"><span class="header-section-number">19</span> Funzioni</a></li>
<li><a class="" href="vettori.html"><span class="header-section-number">20</span> Vettori</a></li>
<li><a class="" href="iterazioni.html"><span class="header-section-number">21</span> Iterazioni</a></li>
<li class="book-part">Model</li>
<li><a class="" href="model-intro.html"><span class="header-section-number">22</span> Introduzione</a></li>
<li><a class="" href="modelli-base.html"><span class="header-section-number">23</span> Modelli base</a></li>
<li><a class="" href="costruire-modelli.html"><span class="header-section-number">24</span> Costruire modelli</a></li>
<li><a class="" href="molti-modelli.html"><span class="header-section-number">25</span> Molti modelli</a></li>
<li class="book-part">Comunicare</li>
<li><a class="" href="communicate-intro.html"><span class="header-section-number">26</span> Introduzione</a></li>
<li><a class="" href="r-markdown.html"><span class="header-section-number">27</span> R Markdown</a></li>
<li><a class="" href="grafici-per-la-comunicazione.html"><span class="header-section-number">28</span> Grafici per la comunicazione</a></li>
<li><a class="" href="formati-di-r-markdown.html"><span class="header-section-number">29</span> Formati di R Markdown</a></li>
<li><a class="" href="r-markdown-workflow.html"><span class="header-section-number">30</span> R Markdown workflow</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/lucavd/r4ds_ita_1st_ed">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="transform" class="section level1" number="5">
<h1>
<span class="header-section-number">5</span> Trasformazione<a class="anchor" aria-label="anchor" href="#transform"><i class="fas fa-link"></i></a>
</h1>
<div id="introduzione-2" class="section level2" number="5.1">
<h2>
<span class="header-section-number">5.1</span> Introduzione<a class="anchor" aria-label="anchor" href="#introduzione-2"><i class="fas fa-link"></i></a>
</h2>
<p>La visualizzazione è uno strumento importante per la generare intuizioni, ma è raro che si ottengano i dati esattamente nella forma giusta di cui si ha bisogno. Spesso avrete bisogno di creare nuove variabili o sommari, o forse volete solo rinominare le variabili o riordinare le osservazioni per rendere i dati un po’ più facili da lavorare. Imparerete come fare tutto questo (e molto di più!) in questo capitolo, che vi insegnerà come trasformare i vostri dati usando il pacchetto dplyr e un nuovo set di dati sui voli in partenza da New York City nel 2013.</p>
<div id="prerequisiti-2" class="section level3" number="5.1.1">
<h3>
<span class="header-section-number">5.1.1</span> Prerequisiti<a class="anchor" aria-label="anchor" href="#prerequisiti-2"><i class="fas fa-link"></i></a>
</h3>
<p>In questo capitolo ci concentreremo su come utilizzare il pacchetto dplyr, un altro membro fondamentale del tidyverse. Illustreremo le idee chiave usando i dati del pacchetto nycflights13 e useremo ggplot2 per aiutarci a capire i dati.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span></code></pre></div>
<p>Fai attenzione al messaggio di conflitto che viene stampato quando carichi il tidyverse. Ti dice che dplyr sovrascrive alcune funzioni in R base. Se vuoi usare la versione base di queste funzioni dopo aver caricato dplyr, dovrai usare i loro nomi completi: <code><a href="https://rdrr.io/r/stats/filter.html">stats::filter()</a></code> e <code><a href="https://rdrr.io/r/stats/lag.html">stats::lag()</a></code>.</p>
</div>
<div id="nycflights13" class="section level3" number="5.1.2">
<h3>
<span class="header-section-number">5.1.2</span> nycflights13<a class="anchor" aria-label="anchor" href="#nycflights13"><i class="fas fa-link"></i></a>
</h3>
<p>Per esplorare i verbi di base di manipolazione dei dati di dplyr, useremo <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">nycflights13::flights</a></code>. Questo data frame contiene tutti i voli 336,776 che sono partiti da New York City nel 2013. I dati provengono dall’US <a href="http://www.transtats.bts.gov/DatabaseInfo.asp?DB_ID=120&amp;Link=0">Bureau of Transportation Statistics</a>, ed è documentato in <code><a href="https://rdrr.io/pkg/nycflights13/man/flights.html">?flights</a></code>.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      517         515       2     830     819      11 UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      533         529       4     850     830      20 UA     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      544         545      -1    1004    1022     -18 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>Potreste notare che questo data frame viene visualizzato in console in modo un po’ diverso da altri data frame che potreste aver usato in passato: mostra solo le prime righe e tutte le colonne che stanno in uno schermo. (Per vedere l’intero dataset, potete eseguire <code>View(flights)</code> che aprirà il dataset nel visualizzatore di RStudio). Si ‘stampa’ (a video) in modo diverso perché è un <strong>tibble</strong>. I tibble sono data frame, ma leggermente modificati per funzionare meglio nel tidyverse. Per ora, non dovete preoccuparvi delle differenze; torneremo sui tibble in modo più dettagliato in <a href="wrangle-intro.html#wrangle-intro">wrangle</a>.</p>
<p>Potreste anche aver notato la fila di abbreviazioni di tre (o quattro) lettere sotto i nomi delle colonne. Queste descrivono il tipo di ogni variabile:</p>
<ul>
<li><p><code>int</code> sta per gli interi.</p></li>
<li><p><code>dbl</code> sta per i doppi, o numeri reali.</p></li>
<li><p><code>chr</code> sta per vettori di caratteri, o stringhe.</p></li>
<li><p><code>dttm</code> sta per data-ora (una data + un’ora).</p></li>
</ul>
<p>Ci sono altri tre tipi comuni di variabili che non sono usati in questo set di dati ma che incontrerete più avanti nel libro:</p>
<ul>
<li><p><code>lgl</code> sta per logico, vettori che contengono solo <code>TRUE</code> o <code>FALSE</code>.</p></li>
<li><p><code>fctr</code> sta per fattori, che R usa per rappresentare variabili categoriche
con possibili valori fissi.</p></li>
<li><p><code>date</code> sta per le date.</p></li>
</ul>
</div>
<div id="basi-del-dplyr" class="section level3" number="5.1.3">
<h3>
<span class="header-section-number">5.1.3</span> Basi del dplyr<a class="anchor" aria-label="anchor" href="#basi-del-dplyr"><i class="fas fa-link"></i></a>
</h3>
<p>In questo capitolo imparerete le cinque funzioni chiave di dplyr che vi permettono di risolvere la maggior parte delle vostre sfide di manipolazione dei dati:</p>
<ul>
<li>Scegliere le osservazioni in base ai loro valori (<code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>).</li>
<li>Riordinare le righe (<code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>).</li>
<li>Scegliere le variabili in base ai loro nomi (<code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>).</li>
<li>Creare nuove variabili con funzioni di variabili esistenti (<code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>).</li>
<li>Collassare molti valori in un singolo sommario (<code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>).</li>
</ul>
<p>Tutte queste funzioni possono essere usate insieme a <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> che cambia lo scopo di ogni funzione dall’operare sull’intero set di dati all’operare su di esso gruppo per gruppo. Queste sei funzioni forniscono i verbi per un linguaggio di manipolazione dei dati.</p>
<p>Tutti i verbi funzionano in modo simile:</p>
<ol style="list-style-type: decimal">
<li><p>Il primo argomento è un data frame.</p></li>
<li><p>Gli argomenti successivi descrivono cosa fare con il data frame,
usando i nomi delle variabili (senza virgolette).</p></li>
<li><p>Il risultato è un nuovo data frame.</p></li>
</ol>
<p>Insieme queste proprietà rendono facile concatenare più passi semplici per ottenere un risultato complesso. Immergiamoci e vediamo come funzionano questi verbi.</p>
</div>
</div>
<div id="filtrare-le-righe-con-filter" class="section level2" number="5.2">
<h2>
<span class="header-section-number">5.2</span> Filtrare le righe con <code>filter()</code><a class="anchor" aria-label="anchor" href="#filtrare-le-righe-con-filter"><i class="fas fa-link"></i></a>
</h2>
<p>La funzione <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> permette di selezionare le osservazioni in base ai loro valori. Il primo argomento è il nome del data frame. Il secondo e i successivi argomenti sono le espressioni che filtrano il data frame. Per esempio, possiamo selezionare tutti i voli del 1° gennaio con:</p>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 842 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      517         515       2     830     819      11 UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      533         529       4     850     830      20 UA     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      544         545      -1    1004    1022     -18 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; # … with 836 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>Quando esegui quella linea di codice, dplyr esegue l’operazione di filtraggio e restituisce un nuovo data frame. Le funzioni dplyr non modificano mai i loro input, quindi se vuoi salvare il risultato, dovrai usare l’operatore di assegnazione, <code>&lt;-</code>:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jan1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">day</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>R stampa i risultati o li salva in una variabile. Se volete fare entrambe le cose, potete avvolgere l’assegnazione tra parentesi:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">dec25</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span> <span class="op">==</span> <span class="fl">12</span>, <span class="va">day</span> <span class="op">==</span> <span class="fl">25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 719 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013    12    25      456         500      -4     649     651      -2 US     </span></span>
<span><span class="co">#&gt; 2  2013    12    25      524         515       9     805     814      -9 UA     </span></span>
<span><span class="co">#&gt; 3  2013    12    25      542         540       2     832     850     -18 AA     </span></span>
<span><span class="co">#&gt; 4  2013    12    25      546         550      -4    1022    1027      -5 B6     </span></span>
<span><span class="co">#&gt; 5  2013    12    25      556         600      -4     730     745     -15 AA     </span></span>
<span><span class="co">#&gt; 6  2013    12    25      557         600      -3     743     752      -9 DL     </span></span>
<span><span class="co">#&gt; # … with 713 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<div id="confronti" class="section level3" number="5.2.1">
<h3>
<span class="header-section-number">5.2.1</span> Confronti<a class="anchor" aria-label="anchor" href="#confronti"><i class="fas fa-link"></i></a>
</h3>
<p>Per usare efficacemente il filtraggio, dovete sapere come selezionare le osservazioni che volete usando gli operatori di confronto. R fornisce la serie standard: <code>&gt;</code>, <code>&gt;=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>!=</code> (non uguale), e <code>==</code> (uguale).</p>
<p>Quando sei agli inizi con R, l’errore più facile da fare è usare <code>=</code> invece di <code>==</code> quando si verifica l’uguaglianza. Quando questo accade otterrete un errore informativo:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, month <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `filter()`:</span></span>
<span><span class="co">#&gt; ! We detected a named input.</span></span>
<span><span class="co">#&gt; ℹ This usually means that you've used `=` instead of `==`.</span></span>
<span><span class="co">#&gt; ℹ Did you mean `month == 1`?</span></span></code></pre></div>
<p>C’è un altro problema comune che potresti incontrare quando usi <code>==</code>: i numeri in virgola mobile. Questi risultati potrebbero sorprenderti!</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span> <span class="op">==</span> <span class="fl">2</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span>
<span><span class="fl">1</span> <span class="op">/</span> <span class="fl">49</span> <span class="op">*</span> <span class="fl">49</span> <span class="op">==</span> <span class="fl">1</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>I computer usano l’aritmetica a precisione finita (ovviamente non possono memorizzare un numero infinito di cifre!) quindi ricordate che ogni numero che vedete è un’approssimazione. Invece di fare affidamento su <code>==</code>, usa <code><a href="https://dplyr.tidyverse.org/reference/near.html">near()</a></code>:</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html">near</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">^</span> <span class="fl">2</span>,  <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/near.html">near</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">49</span> <span class="op">*</span> <span class="fl">49</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
</div>
<div id="operatori-logici" class="section level3" number="5.2.2">
<h3>
<span class="header-section-number">5.2.2</span> Operatori logici<a class="anchor" aria-label="anchor" href="#operatori-logici"><i class="fas fa-link"></i></a>
</h3>
<p>Gli argomenti multipli di <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> sono combinati con “and”: ogni espressione deve essere vera perché una riga sia inclusa nell’output. Per altri tipi di combinazioni, dovrai usare tu stesso gli operatori booleani: <code>&amp;</code> è “and”, <code>|</code> è “or”, e <code>!</code> è “not”. La figura <a href="transform.html#fig:bool-ops">5.1</a> mostra l’insieme completo delle operazioni booleane.</p>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:bool-ops"></span>
<img src="diagrams/transform-logical.png" alt="Set completo di operazioni booleane. `x` è il cerchio di sinistra, `y` è il cerchio di destra, e la regione ombreggiata mostra quali parti ogni operatore seleziona." width="70%"><p class="caption">
Figure 5.1: Set completo di operazioni booleane. <code>x</code> è il cerchio di sinistra, <code>y</code> è il cerchio di destra, e la regione ombreggiata mostra quali parti ogni operatore seleziona.
</p>
</div>
<p>Il seguente codice trova tutti i voli che sono partiti in novembre o dicembre:</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span> <span class="op">==</span> <span class="fl">11</span> <span class="op">|</span> <span class="va">month</span> <span class="op">==</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div>
<p>L’ordine delle operazioni non funziona come l’italiano. Non potete scrivere <code>filter(flights, month == (11 | 12))</code>, che potreste tradurre letteralmente in “trova tutti i voli che sono partiti in novembre o dicembre”. Invece trova tutti i mesi che sono uguali a <code>11 | 12</code>, un’espressione che valuta <code>TRUE</code>. In un contesto numerico (come qui), <code>TRUE</code> diventa uno, quindi questo comando trova tutti i voli in gennaio, non in novembre o dicembre. Il tutto è abbastanza confondente!</p>
<p>Un’utile abbreviazione per questo problema è <code>x %in% y</code>. Questo selezionerà ogni riga dove <code>x</code> è uno dei valori in <code>y</code>. Potremmo usarla per riscrivere il codice sopra:</p>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nov_dec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">month</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">11</span>, <span class="fl">12</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>A volte puoi semplificare i sottoinsiemi complicati ricordando la legge di De Morgan: <code>!(x &amp; y)</code> è uguale a <code>!x | !y</code>, e <code>!(x | y)</code> è uguale a <code>!x &amp; !y</code>. Per esempio, se vuoi trovare i voli che non sono stati in ritardo (all’arrivo o alla partenza) di più di due ore, puoi usare uno dei due filtri seguenti:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="op">!</span><span class="op">(</span><span class="va">arr_delay</span> <span class="op">&gt;</span> <span class="fl">120</span> <span class="op">|</span> <span class="va">dep_delay</span> <span class="op">&gt;</span> <span class="fl">120</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">arr_delay</span> <span class="op">&lt;=</span> <span class="fl">120</span>, <span class="va">dep_delay</span> <span class="op">&lt;=</span> <span class="fl">120</span><span class="op">)</span></span></code></pre></div>
<p>Oltre a <code>&amp;</code> e <code>|</code>, R ha anche <code>&amp;&amp;</code> e <code>||</code>. Non usateli qui! Imparerete quando dovreste usarli in <a href="funzioni.html#esecuzione-condizionale">esecuzione condizionale</a>.</p>
<p>Ogni volta che iniziate ad usare espressioni complicate e composte da più parti in <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>, considerate invece di renderle variabili esplicite. Questo rende molto più facile controllare il vostro lavoro. Imparerai a breve come creare nuove variabili.</p>
</div>
<div id="valori-mancanti" class="section level3" number="5.2.3">
<h3>
<span class="header-section-number">5.2.3</span> Valori mancanti<a class="anchor" aria-label="anchor" href="#valori-mancanti"><i class="fas fa-link"></i></a>
</h3>
<p>Una caratteristica importante di R che può rendere difficile il confronto sono i valori mancanti, o <code>NA</code>s (“not availables”). <code>NA</code> rappresenta un valore sconosciuto quindi i valori mancanti sono “contagiosi”: quasi ogni operazione che coinvolge un valore sconosciuto sarà anch’essa sconosciuta.</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="cn">NA</span> <span class="op">&gt;</span> <span class="fl">5</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="fl">10</span> <span class="op">==</span> <span class="cn">NA</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="cn">NA</span> <span class="op">+</span> <span class="fl">10</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="cn">NA</span> <span class="op">/</span> <span class="fl">2</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<p>Il risultato più disorientante è questo:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="cn">NA</span> <span class="op">==</span> <span class="cn">NA</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<p>È più facile capire perché questo è vero con un po’ più di contesto:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sia x l'età di Mary. Non sappiamo quanti anni ha.</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># Sia y l'età di John. Non sappiamo quanti anni ha.</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="co"># John e Mary hanno la stessa età?</span></span>
<span><span class="va">x</span> <span class="op">==</span> <span class="va">y</span></span>
<span><span class="co">#&gt; [1] NA</span></span>
<span><span class="co"># Non lo sappiamo!</span></span></code></pre></div>
<p>Se volete determinare se un valore è mancante, usate <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code>:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] TRUE</span></span></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code> include solo le righe in cui la condizione è <code>TRUE</code>; esclude sia i valori <code>FALSE</code> che <code>NA</code>. Se vuoi conservare i valori mancanti, chiedili esplicitamente:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="cn">NA</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 1</span></span>
<span><span class="co">#&gt;       x</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     3</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">|</span> <span class="va">x</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 1</span></span>
<span><span class="co">#&gt;       x</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1    NA</span></span>
<span><span class="co">#&gt; 2     3</span></span></code></pre></div>
</div>
<div id="esercizi-8" class="section level3" number="5.2.4">
<h3>
<span class="header-section-number">5.2.4</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-8"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Trovi tutti i voli che</p>
<ol style="list-style-type: decimal">
<li>Hanno avuto un ritardo all’arrivo di due o più ore</li>
<li>Hanno volato a Houston (<code>IAH</code> o <code>HOU</code>)</li>
<li>Sono stati operati da United, American o Delta</li>
<li>Sono partiti in estate (luglio, agosto e settembre)</li>
<li>Sono arrivati con più di due ore di ritardo, ma non sono partiti in ritardo</li>
<li>Hanno subito un ritardo di almeno un’ora, ma hanno recuperato più di 30 minuti di volo</li>
<li>Sono partiti tra mezzanotte e le 6 del mattino (compreso)</li>
</ol>
</li>
<li><p>Un altro utile helper di filtraggio di dplyr è <code><a href="https://dplyr.tidyverse.org/reference/between.html">between()</a></code>. Cosa fa?
Puoi usarlo per semplificare il codice necessario per rispondere alle
sfide precedenti?</p></li>
<li><p>Quanti voli hanno un <code>dep_time</code> mancante? Quali altre variabili sono
mancanti? Cosa potrebbero rappresentare queste righe?</p></li>
<li>
<p>Perché la variabile <code>NA ^ 0</code> non è mancante? 2. Perché <code>NA | TRUE</code> non è mancante?</p>
<ol start="3" style="list-style-type: decimal">
<li>Perché <code>FALSE &amp; NA</code> non è mancante? Puoi capire la
regola generale? (<code>NA * 0</code> è un controesempio insidioso!)</li>
</ol>
</li>
</ol>
</div>
</div>
<div id="organizzare-le-righe-con-arrange" class="section level2" number="5.3">
<h2>
<span class="header-section-number">5.3</span> Organizzare le righe con <code>arrange()</code><a class="anchor" aria-label="anchor" href="#organizzare-le-righe-con-arrange"><i class="fas fa-link"></i></a>
</h2>
<p>Arrange()<code>funziona in modo simile a</code>filter()` tranne che invece di selezionare le righe, cambia il loro ordine. Prende un frame di dati e un insieme di nomi di colonne (o espressioni più complicate) da ordinare. Se fornite più di un nome di colonna, ogni colonna aggiuntiva sarà usata per rompere i legami nei valori delle colonne precedenti:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      517         515       2     830     819      11 UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      533         529       4     850     830      20 UA     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      544         545      -1    1004    1022     -18 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>Usa <code><a href="https://dplyr.tidyverse.org/reference/desc.html">desc()</a></code> per riordinare una colonna in ordine decrescente:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     9      641         900    1301    1242    1530    1272 HA     </span></span>
<span><span class="co">#&gt; 2  2013     6    15     1432        1935    1137    1607    2120    1127 MQ     </span></span>
<span><span class="co">#&gt; 3  2013     1    10     1121        1635    1126    1239    1810    1109 MQ     </span></span>
<span><span class="co">#&gt; 4  2013     9    20     1139        1845    1014    1457    2210    1007 AA     </span></span>
<span><span class="co">#&gt; 5  2013     7    22      845        1600    1005    1044    1815     989 MQ     </span></span>
<span><span class="co">#&gt; 6  2013     4    10     1100        1900     960    1342    2211     931 DL     </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>I valori mancanti sono sempre ordinati alla fine:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">2</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 1</span></span>
<span><span class="co">#&gt;       x</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     2</span></span>
<span><span class="co">#&gt; 2     5</span></span>
<span><span class="co">#&gt; 3    NA</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 1</span></span>
<span><span class="co">#&gt;       x</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     5</span></span>
<span><span class="co">#&gt; 2     2</span></span>
<span><span class="co">#&gt; 3    NA</span></span></code></pre></div>
<div id="esercizi-9" class="section level3" number="5.3.1">
<h3>
<span class="header-section-number">5.3.1</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-9"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Come potreste usare <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code> per ordinare tutti i valori mancanti all’inizio?
(Suggerimento: usate <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code>).</p></li>
<li><p>Ordina <code>flights</code> per trovare i voli più in ritardo. Trova i voli che
sono partiti prima.</p></li>
<li><p>Ordina i voli per trovare i voli più veloci.</p></li>
<li><p>Quali voli hanno viaggiato più lontano? Quali hanno viaggiato più brevemente?</p></li>
</ol>
</div>
</div>
<div id="select" class="section level2" number="5.4">
<h2>
<span class="header-section-number">5.4</span> Seleziona le colonne con <code>select()</code><a class="anchor" aria-label="anchor" href="#select"><i class="fas fa-link"></i></a>
</h2>
<p>Non è raro avere serie di dati con centinaia o addirittura migliaia di variabili. In questo caso, la prima sfida è spesso quella di restringere le variabili a cui si è effettivamente interessati. La funzione <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> permette di zoomare rapidamente su un sottoinsieme utile usando operazioni basate sui nomi delle variabili.</p>
<p>La funzione <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> non è estremamente utile con i dati dei voli perché abbiamo solo 19 variabili, ma potete comunque farvi un’idea generale:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Seleziona le colonne per nome</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 3</span></span>
<span><span class="co">#&gt;    year month   day</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1</span></span>
<span><span class="co">#&gt; 2  2013     1     1</span></span>
<span><span class="co">#&gt; 3  2013     1     1</span></span>
<span><span class="co">#&gt; 4  2013     1     1</span></span>
<span><span class="co">#&gt; 5  2013     1     1</span></span>
<span><span class="co">#&gt; 6  2013     1     1</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span>
<span><span class="co"># Seleziona tutte le colonne tra l'anno e il giorno (incluso)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span><span class="op">:</span><span class="va">day</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 3</span></span>
<span><span class="co">#&gt;    year month   day</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1</span></span>
<span><span class="co">#&gt; 2  2013     1     1</span></span>
<span><span class="co">#&gt; 3  2013     1     1</span></span>
<span><span class="co">#&gt; 4  2013     1     1</span></span>
<span><span class="co">#&gt; 5  2013     1     1</span></span>
<span><span class="co">#&gt; 6  2013     1     1</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span>
<span><span class="co"># Seleziona tutte le colonne tranne quelle dall'anno al giorno (incluso)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="op">-</span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">day</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 16</span></span>
<span><span class="co">#&gt;   dep_time sched…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier flight tailnum origin</span></span>
<span><span class="co">#&gt;      &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1      517     515       2     830     819      11 UA        1545 N14228  EWR   </span></span>
<span><span class="co">#&gt; 2      533     529       4     850     830      20 UA        1714 N24211  LGA   </span></span>
<span><span class="co">#&gt; 3      542     540       2     923     850      33 AA        1141 N619AA  JFK   </span></span>
<span><span class="co">#&gt; 4      544     545      -1    1004    1022     -18 B6         725 N804JB  JFK   </span></span>
<span><span class="co">#&gt; 5      554     600      -6     812     837     -25 DL         461 N668DN  LGA   </span></span>
<span><span class="co">#&gt; 6      554     558      -4     740     728      12 UA        1696 N39463  EWR   </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 6 more variables: dest &lt;chr&gt;, air_time &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated</span></span>
<span><span class="co">#&gt; #   variable names ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time,</span></span>
<span><span class="co">#&gt; #   ⁵​arr_delay</span></span></code></pre></div>
<p>Ci sono un certo numero di funzioni di aiuto che potete usare all’interno di <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>:</p>
<ul>
<li><p><code>starts_with("abc")</code>: corrisponde ai nomi che iniziano con “abc”.</p></li>
<li><p><code>ends_with("xyz")</code>: corrisponde ai nomi che finiscono con “xyz”.</p></li>
<li><p><code>contains("ijk")</code>: corrisponde ai nomi che contengono “ijk”.</p></li>
<li><p><code>matches("(.)\1")</code>: seleziona le variabili che corrispondono a un’espressione regolare.
Questo corrisponde a tutte le variabili che contengono caratteri ripetuti. Imparerete
imparerete di più sulle espressioni regolari in <a href="stringhe.html#stringhe">stringhe</a>.</p></li>
<li><p><code>num_range("x", 1:3)</code>: corrisponde a <code>x1</code>, <code>x2</code> e <code>x3</code>.</p></li>
</ul>
<p>Vedi <code><a href="https://dplyr.tidyverse.org/reference/select.html">?select</a></code> per maggiori dettagli.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> può essere usato per rinominare le variabili, ma è raramente utile perché elimina tutte le variabili non esplicitamente menzionate. Usate invece <code><a href="https://dplyr.tidyverse.org/reference/rename.html">rename()</a></code>, che è una variante di <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> che mantiene tutte le variabili che non sono esplicitamente menzionate:</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span><span class="va">flights</span>, tail_num <span class="op">=</span> <span class="va">tailnum</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      517         515       2     830     819      11 UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      533         529       4     850     830      20 UA     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      544         545      -1    1004    1022     -18 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 9 more variables: flight &lt;int&gt;, tail_num &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>Un’altra opzione è quella di usare <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code> insieme all’helper <code><a href="https://tidyselect.r-lib.org/reference/everything.html">everything()</a></code>. Questo è utile se hai una manciata di variabili che vorresti spostare all’inizio del data frame.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">time_hour</span>, <span class="va">air_time</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 19</span></span>
<span><span class="co">#&gt;   time_hour           air_time  year month   day dep_t…¹ sched…² dep_d…³ arr_t…⁴</span></span>
<span><span class="co">#&gt;   &lt;dttm&gt;                 &lt;dbl&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 2013-01-01 05:00:00      227  2013     1     1     517     515       2     830</span></span>
<span><span class="co">#&gt; 2 2013-01-01 05:00:00      227  2013     1     1     533     529       4     850</span></span>
<span><span class="co">#&gt; 3 2013-01-01 05:00:00      160  2013     1     1     542     540       2     923</span></span>
<span><span class="co">#&gt; 4 2013-01-01 05:00:00      183  2013     1     1     544     545      -1    1004</span></span>
<span><span class="co">#&gt; 5 2013-01-01 06:00:00      116  2013     1     1     554     600      -6     812</span></span>
<span><span class="co">#&gt; 6 2013-01-01 05:00:00      150  2013     1     1     554     558      -4     740</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 10 more variables: sched_arr_time &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;, origin &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   dest &lt;chr&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;, minute &lt;dbl&gt;, and abbreviated</span></span>
<span><span class="co">#&gt; #   variable names ¹​dep_time, ²​sched_dep_time, ³​dep_delay, ⁴​arr_time</span></span></code></pre></div>
<div id="esercizi-10" class="section level3" number="5.4.1">
<h3>
<span class="header-section-number">5.4.1</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-10"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Cerca il maggior numero possibile di modi per selezionare <code>dep_time</code>, <code>dep_delay</code>,
<code>arr_time</code> e <code>arr_delay</code> da <code>flights</code>.</p></li>
<li><p>Cosa succede se includi il nome di una variabile più volte in
una chiamata <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>?</p></li>
<li>
<p>Cosa fa la funzione <code><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of()</a></code>? Perché potrebbe essere utile in congiunzione
con questo vettore?</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"year"</span>, <span class="st">"month"</span>, <span class="st">"day"</span>, <span class="st">"dep_delay"</span>, <span class="st">"arr_delay"</span><span class="op">)</span></span></code></pre></div>
</li>
<li>
<p>Il risultato dell’esecuzione del seguente codice vi sorprende? Come trattano le maiuscole le funzioni di aiuto di
select in modo predefinito? Come si può cambiare questo default?</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">contains</a></span><span class="op">(</span><span class="st">"TIME"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</li>
</ol>
</div>
</div>
<div id="aggiungere-nuove-variabili-con-mutate" class="section level2" number="5.5">
<h2>
<span class="header-section-number">5.5</span> Aggiungere nuove variabili con <code>mutate()</code><a class="anchor" aria-label="anchor" href="#aggiungere-nuove-variabili-con-mutate"><i class="fas fa-link"></i></a>
</h2>
<p>Oltre a selezionare insiemi di colonne esistenti, è spesso utile aggiungere nuove colonne che sono funzioni di colonne esistenti. Questo è il compito di <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>.</p>
<p>La funzione <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> aggiunge sempre nuove colonne alla fine del vostro dataset, quindi inizieremo creando un dataset più piccolo in modo da poter vedere le nuove variabili. Ricordate che quando siete in RStudio, il modo più semplice per vedere tutte le colonne è <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_sml</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">flights</span>, </span>
<span>  <span class="va">year</span><span class="op">:</span><span class="va">day</span>, </span>
<span>  <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">ends_with</a></span><span class="op">(</span><span class="st">"delay"</span><span class="op">)</span>, </span>
<span>  <span class="va">distance</span>, </span>
<span>  <span class="va">air_time</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">flights_sml</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  speed <span class="op">=</span> <span class="va">distance</span> <span class="op">/</span> <span class="va">air_time</span> <span class="op">*</span> <span class="fl">60</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 9</span></span>
<span><span class="co">#&gt;    year month   day dep_delay arr_delay distance air_time  gain speed</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1         2        11     1400      227    -9  370.</span></span>
<span><span class="co">#&gt; 2  2013     1     1         4        20     1416      227   -16  374.</span></span>
<span><span class="co">#&gt; 3  2013     1     1         2        33     1089      160   -31  408.</span></span>
<span><span class="co">#&gt; 4  2013     1     1        -1       -18     1576      183    17  517.</span></span>
<span><span class="co">#&gt; 5  2013     1     1        -6       -25      762      116    19  394.</span></span>
<span><span class="co">#&gt; 6  2013     1     1        -4        12      719      150   -16  288.</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span></code></pre></div>
<p>Nota che puoi fare riferimento alle colonne che hai appena creato:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">flights_sml</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  hours <span class="op">=</span> <span class="va">air_time</span> <span class="op">/</span> <span class="fl">60</span>,</span>
<span>  gain_per_hour <span class="op">=</span> <span class="va">gain</span> <span class="op">/</span> <span class="va">hours</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 10</span></span>
<span><span class="co">#&gt;    year month   day dep_delay arr_delay distance air_time  gain hours gain_per…¹</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1         2        11     1400      227    -9  3.78      -2.38</span></span>
<span><span class="co">#&gt; 2  2013     1     1         4        20     1416      227   -16  3.78      -4.23</span></span>
<span><span class="co">#&gt; 3  2013     1     1         2        33     1089      160   -31  2.67     -11.6 </span></span>
<span><span class="co">#&gt; 4  2013     1     1        -1       -18     1576      183    17  3.05       5.57</span></span>
<span><span class="co">#&gt; 5  2013     1     1        -6       -25      762      116    19  1.93       9.83</span></span>
<span><span class="co">#&gt; 6  2013     1     1        -4        12      719      150   -16  2.5       -6.4 </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, and abbreviated variable name ¹​gain_per_hour</span></span></code></pre></div>
<p>Se volete mantenere solo le nuove variabili, usate <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute()</a></code>:</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">flights</span>,</span>
<span>  gain <span class="op">=</span> <span class="va">dep_delay</span> <span class="op">-</span> <span class="va">arr_delay</span>,</span>
<span>  hours <span class="op">=</span> <span class="va">air_time</span> <span class="op">/</span> <span class="fl">60</span>,</span>
<span>  gain_per_hour <span class="op">=</span> <span class="va">gain</span> <span class="op">/</span> <span class="va">hours</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 3</span></span>
<span><span class="co">#&gt;    gain hours gain_per_hour</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1    -9  3.78         -2.38</span></span>
<span><span class="co">#&gt; 2   -16  3.78         -4.23</span></span>
<span><span class="co">#&gt; 3   -31  2.67        -11.6 </span></span>
<span><span class="co">#&gt; 4    17  3.05          5.57</span></span>
<span><span class="co">#&gt; 5    19  1.93          9.83</span></span>
<span><span class="co">#&gt; 6   -16  2.5          -6.4 </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span></code></pre></div>
<div id="mutate-funs" class="section level3" number="5.5.1">
<h3>
<span class="header-section-number">5.5.1</span> Funzioni utili per creare variabili<a class="anchor" aria-label="anchor" href="#mutate-funs"><i class="fas fa-link"></i></a>
</h3>
<p>Ci sono molte funzioni per creare nuove variabili che potete usare con <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>. La proprietà chiave è che la funzione deve essere vettorializzata: deve prendere un vettore di valori come input, restituire un vettore con lo stesso numero di valori come output. Non c’è modo di elencare tutte le possibili funzioni che potreste usare, ma ecco una selezione di funzioni che sono spesso utili:</p>
<ul>
<li>
<p>Operatori aritmetici: <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, <code>^</code>. Questi sono tutti vettorializzati,
usando le cosiddette “regole di riciclaggio”. Se un parametro è più corto dell’altro,
sarà automaticamente esteso per avere la stessa lunghezza. E’
molto utile quando uno degli argomenti è un singolo numero: <code>air_time / 60</code>,
<code>ore * 60 + minuti</code>, ecc.</p>
<p>Gli operatori aritmetici sono utili anche in combinazione con le funzioni
che imparerete in seguito. Per esempio, <code>x / sum(x)</code> calcola
la proporzione di un totale, e <code>y - mean(y)</code> calcola la differenza dalla
la media.</p>
</li>
<li>
<p>Aritmetica modulare: <code>%/%</code> (divisione intera) e <code>%%</code> (resto), dove
<code>x == y * (x %/% y) + (x %% y)</code>. L’aritmetica modulare è uno strumento utile perché
ti permette di spezzare gli interi in pezzi. Per esempio, nel set di dati
voli, puoi calcolare <code>ora</code> e <code>minuto</code> da <code>dep_time</code> con:</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">flights</span>,</span>
<span>  <span class="va">dep_time</span>,</span>
<span>  hour <span class="op">=</span> <span class="va">dep_time</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%/%</a></span> <span class="fl">100</span>,</span>
<span>  minute <span class="op">=</span> <span class="va">dep_time</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html">%%</a></span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 3</span></span>
<span><span class="co">#&gt;   dep_time  hour minute</span></span>
<span><span class="co">#&gt;      &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1      517     5     17</span></span>
<span><span class="co">#&gt; 2      533     5     33</span></span>
<span><span class="co">#&gt; 3      542     5     42</span></span>
<span><span class="co">#&gt; 4      544     5     44</span></span>
<span><span class="co">#&gt; 5      554     5     54</span></span>
<span><span class="co">#&gt; 6      554     5     54</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span></code></pre></div>
</li>
<li>
<p>Logaritmi: <code><a href="https://rdrr.io/r/base/Log.html">log()</a></code>, <code><a href="https://rdrr.io/r/base/Log.html">log2()</a></code>, <code><a href="https://rdrr.io/r/base/Log.html">log10()</a></code>. I logaritmi sono una trasformazione incredibilmente utile
per trattare con dati che spaziano su più ordini di
grandezza. Essi convertono anche relazioni moltiplicative in additive, una
caratteristica su cui torneremo nella modellazione.</p>
<p>A parità di condizioni, raccomando di usare <code><a href="https://rdrr.io/r/base/Log.html">log2()</a></code> perché è facile da
interpretare: una differenza di 1 sulla scala log corrisponde al raddoppio sulla
scala originale e una differenza di -1 corrisponde al dimezzamento.</p>
</li>
<li>
<p>Offset: <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead()</a></code> e <code>lag()</code> vi permettono di fare riferimento a valori in testa o in coda
valori. Questo vi permette di calcolare le differenze correnti (ad esempio, <code>x - lag(x)</code>)
o trovare quando i valori cambiano (<code>x != lag(x)</code>). Sono molto utili in
insieme a <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>, che imparerete a conoscere tra poco.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10</span></span>
<span><span class="fu">lag</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] NA  1  2  3  4  5  6  7  8  9</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lead</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  2  3  4  5  6  7  8  9 10 NA</span></span></code></pre></div>
</li>
<li>
<p>Aggregati cumulativi e rotativi: R fornisce funzioni per eseguire somme,
prodotti, minimi e massimi: <code><a href="https://rdrr.io/r/base/cumsum.html">cumsum()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html">cumprod()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html">cummin()</a></code>, <code><a href="https://rdrr.io/r/base/cumsum.html">cummax()</a></code>;
e dplyr fornisce <code><a href="https://dplyr.tidyverse.org/reference/cumall.html">cummean()</a></code> per le medie cumulative. Se avete bisogno di aggregati rotativi
(cioè una somma calcolata su una finestra mobile), provate il pacchetto RcppRoll.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span></span>
<span><span class="co">#&gt;  [1]  1  2  3  4  5  6  7  8  9 10</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  1  3  6 10 15 21 28 36 45 55</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/cumall.html">cummean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] 1.0 1.5 2.0 2.5 3.0 3.5 4.0 4.5 5.0 5.5</span></span></code></pre></div>
</li>
<li><p>Confronti logici: <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code>, <code>&gt;=</code>, <code>!=</code>, e <code>==</code>, che hai imparato
prima. Se stai facendo una complessa sequenza di operazioni logiche è
spesso una buona idea memorizzare i valori intermedi in nuove variabili in modo da poter
controllare che ogni passo funzioni come previsto.</p></li>
<li>
<p>Rango: ci sono un certo numero di funzioni per i ranghi, ma si dovrebbe
iniziare con <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank()</a></code>. Esegue il tipo più usuale di classifica
(es. 1°, 2°, 2°, 4°). Il default dà ai valori più piccoli il più piccolo dei
ranghi; usate <code>desc(x)</code> per dare ai valori più grandi i ranghi più piccoli.</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="cn">NA</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1  2  2 NA  4  5</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  5  3  3 NA  2  1</span></span></code></pre></div>
<p>Se <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank()</a></code> non fa ciò di cui avete bisogno, guardate le varianti
<code><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">dense_rank()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">percent_rank()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">cume_dist()</a></code>,
<code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code>. Vedi le loro pagine di aiuto per maggiori dettagli.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1  2  3 NA  4  5</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">dense_rank</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1  2  2 NA  3  4</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">percent_rank</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.00 0.25 0.25   NA 0.75 1.00</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">cume_dist</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.2 0.6 0.6  NA 0.8 1.0</span></span></code></pre></div>
</li>
</ul>
</div>
<div id="esercizi-11" class="section level3" number="5.5.2">
<h3>
<span class="header-section-number">5.5.2</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-11"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Attualmente <code>dep_time</code> e <code>sched_dep_time</code> sono comodi da guardare, ma
difficili da calcolare perché non sono realmente numeri continui.
Convertirli in una rappresentazione più conveniente del numero di minuti
dalla mezzanotte.</p></li>
<li><p>Confronta <code>air_time</code> con <code>arr_time - dep_time</code>. Cosa ti aspetti di vedere?
Cosa vedi? Cosa devi fare per risolvere il problema?</p></li>
<li><p>Confronta <code>dep_time</code>, <code>sched_dep_time</code> e <code>dep_delay</code>. Come ti aspetteresti
aspettarti che questi tre numeri siano correlati?</p></li>
<li><p>Trova i 10 voli più in ritardo usando una funzione di classifica. Come vuoi
gestire i pareggi? Leggete attentamente la documentazione per <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank()</a></code>.</p></li>
<li><p>Cosa restituisce <code>1:3 + 1:10</code>? Perché?</p></li>
<li><p>Quali funzioni trigonometriche fornisce R?</p></li>
</ol>
</div>
</div>
<div id="summary-funs" class="section level2" number="5.6">
<h2>
<span class="header-section-number">5.6</span> Riassunti raggruppati con <code>summarise()</code><a class="anchor" aria-label="anchor" href="#summary-funs"><i class="fas fa-link"></i></a>
</h2>
<p>L’ultimo verbo chiave è <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>. Esso collassa un frame di dati in una singola riga:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">flights</span>, delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 1</span></span>
<span><span class="co">#&gt;   delay</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  12.6</span></span></code></pre></div>
<p>(Torneremo a breve sul significato di quel <code>na.rm = TRUE</code>).</p>
<p>La funzione <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> non è estremamente utile a meno che non la accoppiamo con la funzione <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>. Questo cambia l’unità di analisi dall’intero set di dati ai singoli gruppi. Quindi, quando usate i verbi di dplyr su un data frame raggruppato, essi saranno automaticamente applicati “per gruppo”. Per esempio, se applicassimo esattamente lo stesso codice a un data frame raggruppato per data, otterremmo il ritardo medio per data:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_day</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">by_day</span>, delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day delay</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1 11.5 </span></span>
<span><span class="co">#&gt; 2  2013     1     2 13.9 </span></span>
<span><span class="co">#&gt; 3  2013     1     3 11.0 </span></span>
<span><span class="co">#&gt; 4  2013     1     4  8.95</span></span>
<span><span class="co">#&gt; 5  2013     1     5  5.73</span></span>
<span><span class="co">#&gt; 6  2013     1     6  7.15</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
<p>Insieme <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code> forniscono uno degli strumenti che userete più comunemente quando lavorate con dplyr: i sommari raggruppati. Ma prima di andare avanti con questo, dobbiamo introdurre una nuova potente idea: la pipe.</p>
<div id="combinare-più-operazioni-con-la-pipe" class="section level3" number="5.6.1">
<h3>
<span class="header-section-number">5.6.1</span> Combinare più operazioni con la ‘pipe’<a class="anchor" aria-label="anchor" href="#combinare-pi%C3%B9-operazioni-con-la-pipe"><i class="fas fa-link"></i></a>
</h3>
<p>Immaginate di voler esplorare la relazione tra la distanza e il ritardo medio per ogni località. Usando quello che sapete su dplyr, potreste scrivere del codice come questo:</p>
<div class="sourceCode" id="cb100"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">by_dest</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">dest</span><span class="op">)</span></span>
<span><span class="va">delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">by_dest</span>,</span>
<span>  count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">distance</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">delay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">delay</span>, <span class="va">count</span> <span class="op">&gt;</span> <span class="fl">20</span>, <span class="va">dest</span> <span class="op">!=</span> <span class="st">"HNL"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sembra che i ritardi aumentino con la distanza fino a ~750 miglia </span></span>
<span><span class="co"># e poi diminuiscono. Forse quando i voli diventano più lunghi c'è più </span></span>
<span><span class="co"># capacità di recuperare i ritardi in volo?</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">delay</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dist</span>, y <span class="op">=</span> <span class="va">delay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>size <span class="op">=</span> <span class="va">count</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'loess' and formula = 'y ~ x'</span></span></code></pre></div>
<div class="inline-figure"><img src="transform_files/figure-html/unnamed-chunk-35-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Ci sono tre passi per preparare questi dati:</p>
<ol style="list-style-type: decimal">
<li><p>Raggruppare i voli per destinazione.</p></li>
<li><p>Riassumere per calcolare la distanza, il ritardo medio e il numero di voli.</p></li>
<li><p>Filtrare per rimuovere i punti ‘rumorosi’ e l’aeroporto di Honolulu, che è quasi
due volte più lontano del prossimo aeroporto più vicino.</p></li>
</ol>
<p>Questo codice è un po’ frustrante da scrivere perché dobbiamo dare un nome ad ogni data frame intermedio, anche se non ci interessa. Dare un nome alle cose è difficile, quindi questo rallenta la nostra analisi.</p>
<p>C’è un altro modo per affrontare lo stesso problema con la pipe (‘condotta’ o ‘tubatura’), <code>%&gt;%</code>:</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">distance</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">count</span> <span class="op">&gt;</span> <span class="fl">20</span>, <span class="va">dest</span> <span class="op">!=</span> <span class="st">"HNL"</span><span class="op">)</span></span></code></pre></div>
<p>Questo si concentra sulle trasformazioni, non su ciò che viene trasformato, il che rende il codice più facile da leggere. Potete leggerlo come una serie di dichiarazioni imperative: raggruppare, poi riassumere, poi filtrare. Come suggerito da questa lettura, un buon modo di pronunciare <code>%&gt;%</code> quando si legge il codice è “poi”.</p>
<p>Dietro le quinte, <code>x %&gt;% f(y)</code> si trasforma in <code>f(x, y)</code>, e <code>x %&gt;% f(y) %&gt;% g(z)</code> si trasforma in <code>g(f(x, y), z)</code> e così via. Puoi usare la pipe per riscrivere operazioni multiple in modo da poterle leggere da sinistra a destra, dall’alto in basso. Useremo spesso la pipe d’ora in poi perché migliora considerevolmente la leggibilità del codice, e torneremo su di esso in modo più dettagliato in <a href="pipe.html#pipe">pipe</a>.</p>
<p>Lavorare con la pipe è uno dei criteri chiave per appartenere al tidyverse. L’unica eccezione è ggplot2: è stato scritto prima che la pipe fosse scoperta. Sfortunatamente, la prossima iterazione di ggplot2, ggvis, che usa la pipe, non è ancora pronta per il prime time.</p>
</div>
<div id="valori-mancanti-1" class="section level3" number="5.6.2">
<h3>
<span class="header-section-number">5.6.2</span> Valori mancanti<a class="anchor" aria-label="anchor" href="#valori-mancanti-1"><i class="fas fa-link"></i></a>
</h3>
<p>Vi sarete chiesti quale sia l’argomento <code>na.rm</code> che abbiamo usato sopra. Cosa succede se non lo impostiamo?</p>
<div class="sourceCode" id="cb102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day  mean</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1    NA</span></span>
<span><span class="co">#&gt; 2  2013     1     2    NA</span></span>
<span><span class="co">#&gt; 3  2013     1     3    NA</span></span>
<span><span class="co">#&gt; 4  2013     1     4    NA</span></span>
<span><span class="co">#&gt; 5  2013     1     5    NA</span></span>
<span><span class="co">#&gt; 6  2013     1     6    NA</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
<p>Abbiamo un sacco di valori mancanti! Questo perché le funzioni di aggregazione obbediscono alla solita regola dei valori mancanti: se c’è un qualsiasi valore mancante nell’input, l’output sarà un valore mancante. Fortunatamente, tutte le funzioni di aggregazione hanno un argomento <code>na.rm</code> che rimuove i valori mancanti prima del calcolo:</p>
<div class="sourceCode" id="cb103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day  mean</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1 11.5 </span></span>
<span><span class="co">#&gt; 2  2013     1     2 13.9 </span></span>
<span><span class="co">#&gt; 3  2013     1     3 11.0 </span></span>
<span><span class="co">#&gt; 4  2013     1     4  8.95</span></span>
<span><span class="co">#&gt; 5  2013     1     5  5.73</span></span>
<span><span class="co">#&gt; 6  2013     1     6  7.15</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
<p>In questo caso, dove i valori mancanti rappresentano voli cancellati, potremmo anche affrontare il problema rimuovendo prima i voli cancellati. Salveremo questo set di dati in modo da poterlo riutilizzare nei prossimi esempi.</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_cancelled</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">dep_delay</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day  mean</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1 11.4 </span></span>
<span><span class="co">#&gt; 2  2013     1     2 13.7 </span></span>
<span><span class="co">#&gt; 3  2013     1     3 10.9 </span></span>
<span><span class="co">#&gt; 4  2013     1     4  8.97</span></span>
<span><span class="co">#&gt; 5  2013     1     5  5.73</span></span>
<span><span class="co">#&gt; 6  2013     1     6  7.15</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
</div>
<div id="dati-di-conteggio" class="section level3" number="5.6.3">
<h3>
<span class="header-section-number">5.6.3</span> Dati di conteggio<a class="anchor" aria-label="anchor" href="#dati-di-conteggio"><i class="fas fa-link"></i></a>
</h3>
<p>Ogni volta che fate un’aggregazione, è sempre una buona idea includere o un conteggio (<code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code>), o un conteggio dei valori non mancanti (<code>sum(!is.na(x))</code>). In questo modo potete controllare che non stiate traendo conclusioni basate su quantità molto piccole di dati. Per esempio, guardiamo gli aerei (identificati dal loro numero di coda) che hanno i ritardi medi più alti:</p>
<div class="sourceCode" id="cb105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">delays</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">delay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_freqpoly</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="transform_files/figure-html/unnamed-chunk-40-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Wow, ci sono alcuni aerei che hanno un ritardo <em>medio</em> di 5 ore (300 minuti)!</p>
<p>La storia è in realtà un po’ più sfumata. Possiamo ottenere maggiori informazioni se disegniamo un grafico a dispersione del numero di voli rispetto al ritardo medio:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op">&lt;-</span> <span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    delay <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">delays</span>, mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">delay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="transform_files/figure-html/unnamed-chunk-41-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Non sorprende che ci sia una variazione molto maggiore nel ritardo medio quando ci sono pochi voli. La forma di questo grafico è molto caratteristica: ogni volta che tracciate una media (o un altro riassunto) rispetto alla dimensione del gruppo, vedrete che la variazione diminuisce all’aumentare della dimensione del campione.</p>
<p>Quando si guarda questo tipo di grafico, è spesso utile filtrare i gruppi con il più piccolo numero di osservazioni, in modo da poter vedere più il modello e meno la variazione estrema nei gruppi più piccoli. Questo è ciò che fa il seguente codice, oltre a mostrarvi un comodo schema per integrare ggplot2 nei flussi di dplyr. È un po’ doloroso dover passare da <code>%&gt;%</code> a <code>+</code>, ma una volta che ci si prende la mano, è abbastanza comodo.</p>
<div class="sourceCode" id="cb107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">delays</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">25</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">n</span>, y <span class="op">=</span> <span class="va">delay</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="transform_files/figure-html/unnamed-chunk-42-1.png" width="70%" style="display: block; margin: auto;"></div>
<hr>
<p>Suggerimento RStudio: un’utile scorciatoia da tastiera è Cmd/Ctrl + Shift + P. Questo rimanda il chunk precedentemente inviato dall’editor alla console. Questo è molto comodo quando stai (per esempio) esplorando il valore di <code>n</code> nell’esempio sopra. Invii l’intero blocco una volta con Cmd/Ctrl + Invio, poi modifichi il valore di <code>n</code> e premi Cmd/Ctrl + Shift + P per inviare nuovamente il blocco completo.</p>
<hr>
<p>C’è un’altra variazione comune di questo tipo di schema. Guardiamo come la performance media dei battitori nel baseball è legata al numero di volte che sono alla battuta. Qui uso i dati del pacchetto <strong>Lahman</strong> per calcolare la media di battuta (numero di colpi / numero di tentativi) di ogni giocatore di baseball della Major League.</p>
<p>Quando tracciamo il grafico dell’abilità del battitore (misurata dalla media di battuta, <code>ba</code>) contro il numero di opportunità di colpire la palla (misurata dalla battuta, <code>ab</code>), si vedono due modelli:</p>
<ol style="list-style-type: decimal">
<li><p>Come sopra, la variazione del nostro aggregato diminuisce man mano che abbiamo più
punti dati.</p></li>
<li><p>C’è una correlazione positiva tra abilità (<code>ba</code>) e opportunità di
colpire la palla (<code>ab</code>). Questo perché le squadre controllano chi può giocare,
e ovviamente sceglieranno i loro migliori giocatori.</p></li>
</ol>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convertiamo in tibble in modo che si stampi bene</span></span>
<span><span class="va">batting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="fu">Lahman</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/Lahman/man/Batting.html">Batting</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">batters</span> <span class="op">&lt;-</span> <span class="va">batting</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">playerID</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    ba <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">H</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">AB</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    ab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">AB</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">batters</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ab</span> <span class="op">&gt;</span> <span class="fl">100</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ab</span>, y <span class="op">=</span> <span class="va">ba</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula = 'y ~ s(x, bs = "cs")'</span></span></code></pre></div>
<div class="inline-figure"><img src="transform_files/figure-html/unnamed-chunk-43-1.png" width="70%" style="display: block; margin: auto;"></div>
<p>Questo ha anche importanti implicazioni per i ranghi. Se si ordina ingenuamente in base a <code>desc(ba)</code>, le persone con le migliori medie di battuta sono chiaramente fortunate, non abili:</p>
<div class="sourceCode" id="cb109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">batters</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">ba</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 20,166 × 3</span></span>
<span><span class="co">#&gt;   playerID     ba    ab</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 abramge01     1     1</span></span>
<span><span class="co">#&gt; 2 alberan01     1     1</span></span>
<span><span class="co">#&gt; 3 banisje01     1     1</span></span>
<span><span class="co">#&gt; 4 bartocl01     1     1</span></span>
<span><span class="co">#&gt; 5 bassdo01      1     1</span></span>
<span><span class="co">#&gt; 6 birasst01     1     2</span></span>
<span><span class="co">#&gt; # … with 20,160 more rows</span></span></code></pre></div>
<p>Potete trovare una buona spiegazione di questo problema in <a href="http://varianceexplained.org/r/empirical_bayes_baseball/" class="uri">http://varianceexplained.org/r/empirical_bayes_baseball/</a> e <a href="http://www.evanmiller.org/how-not-to-sort-by-average-rating.html" class="uri">http://www.evanmiller.org/how-not-to-sort-by-average-rating.html</a>.</p>
</div>
<div id="summarise-funs" class="section level3" number="5.6.4">
<h3>
<span class="header-section-number">5.6.4</span> Funzioni di riepilogo utili<a class="anchor" aria-label="anchor" href="#summarise-funs"><i class="fas fa-link"></i></a>
</h3>
<p>Usare solo le medie, i conteggi e la somma può portarvi molto lontano, ma R fornisce molte altre utili funzioni di riepilogo:</p>
<ul>
<li>
<p>Misure di posizione: abbiamo usato <code>mean(x)</code>, ma anche <code>median(x)</code> è
utile. La media è la somma divisa per la lunghezza; la mediana è un valore
dove il 50% di <code>x</code> è al di sopra di esso, e il 50% è al di sotto.</p>
<p>A volte è utile combinare l’aggregazione con il sottoinsieme logico.
Non abbiamo ancora parlato di questo tipo di sottoinsiemi, ma imparerete di più
su di esso in <a href="vettori.html#vector-subsetting">sottoinsiemi</a>.</p>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    avg_delay1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span>,</span>
<span>    avg_delay2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">[</span><span class="va">arr_delay</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span> <span class="co"># the average positive delay</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 5</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day avg_delay1 avg_delay2</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      12.7        32.5</span></span>
<span><span class="co">#&gt; 2  2013     1     2      12.7        32.0</span></span>
<span><span class="co">#&gt; 3  2013     1     3       5.73       27.7</span></span>
<span><span class="co">#&gt; 4  2013     1     4      -1.93       28.3</span></span>
<span><span class="co">#&gt; 5  2013     1     5      -1.53       22.6</span></span>
<span><span class="co">#&gt; 6  2013     1     6       4.24       24.4</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
</li>
<li>
<p>Misure di spread: <code>sd(x)</code>, <code>IQR(x)</code>, <code>mad(x)</code>. La deviazione quadratica media,
o deviazione standard <code>sd(x)</code>, è la misura standard di diffusione.
L’intervallo interquartile <code>IQR(x)</code> e la deviazione assoluta mediana <code>mad(x)</code>
sono equivalenti robusti che possono essere più utili se hai dei valori anomali.</p>
<div class="sourceCode" id="cb111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Why is distance to some destinations more variable than to others?</span></span>
<span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>distance_sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span><span class="op">(</span><span class="va">distance</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">distance_sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 104 × 2</span></span>
<span><span class="co">#&gt;   dest  distance_sd</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;       &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 EGE         10.5 </span></span>
<span><span class="co">#&gt; 2 SAN         10.4 </span></span>
<span><span class="co">#&gt; 3 SFO         10.2 </span></span>
<span><span class="co">#&gt; 4 HNL         10.0 </span></span>
<span><span class="co">#&gt; 5 SEA          9.98</span></span>
<span><span class="co">#&gt; 6 LAS          9.91</span></span>
<span><span class="co">#&gt; # … with 98 more rows</span></span></code></pre></div>
</li>
<li>
<p>Misure di rango: <code>min(x)</code>, <code>quantile(x, 0.25)</code>, <code>max(x)</code>. I quantili
sono una generalizzazione della mediana. Per esempio, <code>quantile(x, 0.25)</code>
troverà un valore di <code>x</code> che è maggiore del 25% dei valori,
e inferiore al restante 75%.</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># When do the first and last flights leave each day?</span></span>
<span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    first <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">dep_time</span><span class="op">)</span>,</span>
<span>    last <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">dep_time</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 5</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day first  last</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1   517  2356</span></span>
<span><span class="co">#&gt; 2  2013     1     2    42  2354</span></span>
<span><span class="co">#&gt; 3  2013     1     3    32  2349</span></span>
<span><span class="co">#&gt; 4  2013     1     4    25  2358</span></span>
<span><span class="co">#&gt; 5  2013     1     5    14  2357</span></span>
<span><span class="co">#&gt; 6  2013     1     6    16  2355</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
</li>
<li>
<p>Misure di posizione: <code>primo(x)</code>, <code>n°(x, 2)</code>, <code>ultimo(x)</code>. Queste funzionano
in modo simile a <code>x[1]</code>, <code>x[2]</code>, e <code>x[lunghezza(x)]</code> ma vi permettono di impostare un valore predefinito
valore se quella posizione non esiste (ad esempio, state cercando di ottenere il terzo
elemento da un gruppo che ha solo due elementi). Per esempio, possiamo
trovare la prima e l’ultima partenza per ogni giorno:</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span></span>
<span>    first_dep <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">first</a></span><span class="op">(</span><span class="va">dep_time</span><span class="op">)</span>, </span>
<span>    last_dep <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html">last</a></span><span class="op">(</span><span class="va">dep_time</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 5</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day first_dep last_dep</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;int&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1       517     2356</span></span>
<span><span class="co">#&gt; 2  2013     1     2        42     2354</span></span>
<span><span class="co">#&gt; 3  2013     1     3        32     2349</span></span>
<span><span class="co">#&gt; 4  2013     1     4        25     2358</span></span>
<span><span class="co">#&gt; 5  2013     1     5        14     2357</span></span>
<span><span class="co">#&gt; 6  2013     1     6        16     2355</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
<p>Queste funzioni sono complementari al filtraggio sui ranghi. Il filtraggio dà
tutte le variabili, con ogni osservazione in una riga separata:</p>
<div class="sourceCode" id="cb114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>r <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">dep_time</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">r</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/range.html">range</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 770 × 20</span></span>
<span><span class="co">#&gt; # Groups:   year, month, day [365]</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      517         515       2     830     819      11 UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1     2356        2359      -3     425     437     -12 B6     </span></span>
<span><span class="co">#&gt; 3  2013     1     2       42        2359      43     518     442      36 B6     </span></span>
<span><span class="co">#&gt; 4  2013     1     2     2354        2359      -5     413     437     -24 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     3       32        2359      33     504     442      22 B6     </span></span>
<span><span class="co">#&gt; 6  2013     1     3     2349        2359     -10     434     445     -11 B6     </span></span>
<span><span class="co">#&gt; # … with 764 more rows, 10 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, r &lt;int&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
</li>
<li>
<p>Conteggi: Avete visto <code><a href="https://dplyr.tidyverse.org/reference/context.html">n()</a></code>, che non prende argomenti e restituisce la
dimensione del gruppo corrente. Per contare il numero di valori non mancanti, usate
<code>sum(!is.na(x))</code>. Per contare il numero di valori distinti (unici), usate
<code>n_distinct(x)</code>.</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Which destinations have the most carriers?</span></span>
<span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>carriers <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/n_distinct.html">n_distinct</a></span><span class="op">(</span><span class="va">carrier</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">carriers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 104 × 2</span></span>
<span><span class="co">#&gt;   dest  carriers</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 ATL          7</span></span>
<span><span class="co">#&gt; 2 BOS          7</span></span>
<span><span class="co">#&gt; 3 CLT          7</span></span>
<span><span class="co">#&gt; 4 ORD          7</span></span>
<span><span class="co">#&gt; 5 TPA          7</span></span>
<span><span class="co">#&gt; 6 AUS          6</span></span>
<span><span class="co">#&gt; # … with 98 more rows</span></span></code></pre></div>
<p>I conteggi sono così utili che dplyr fornisce un semplice aiuto se tutto ciò che si vuole è
un conteggio:</p>
<div class="sourceCode" id="cb116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 104 × 2</span></span>
<span><span class="co">#&gt;   dest      n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 ABQ     254</span></span>
<span><span class="co">#&gt; 2 ACK     264</span></span>
<span><span class="co">#&gt; 3 ALB     418</span></span>
<span><span class="co">#&gt; 4 ANC       8</span></span>
<span><span class="co">#&gt; 5 ATL   16837</span></span>
<span><span class="co">#&gt; 6 AUS    2411</span></span>
<span><span class="co">#&gt; # … with 98 more rows</span></span></code></pre></div>
<p>Potete opzionalmente fornire una variabile di peso. Per esempio, potreste usare
questo per “contare” (sommare) il numero totale di miglia volate da un aereo:</p>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">tailnum</span>, wt <span class="op">=</span> <span class="va">distance</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4,037 × 2</span></span>
<span><span class="co">#&gt;   tailnum      n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 D942DN    3418</span></span>
<span><span class="co">#&gt; 2 N0EGMQ  239143</span></span>
<span><span class="co">#&gt; 3 N10156  109664</span></span>
<span><span class="co">#&gt; 4 N102UW   25722</span></span>
<span><span class="co">#&gt; 5 N103US   24619</span></span>
<span><span class="co">#&gt; 6 N104UW   24616</span></span>
<span><span class="co">#&gt; # … with 4,031 more rows</span></span></code></pre></div>
</li>
<li>
<p>Conteggi e proporzioni di valori logici: <code>sum(x &gt; 10)</code>, <code>mean(y == 0)</code>.
Quando viene usato con funzioni numeriche, <code>TRUE</code> è convertito in 1 e <code>FALSE</code> in 0.
Questo rende <code><a href="https://rdrr.io/r/base/sum.html">sum()</a></code> e <code><a href="https://rdrr.io/r/base/mean.html">mean()</a></code> molto utili: La <code>somma(x)</code> dà il numero di
<code>TRUE</code>s in <code>x</code>, e <code>mean(x)</code>dà la proporzione.</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Quanti voli sono partiti prima delle 5 del mattino? (questi di solito </span></span>
<span><span class="co"># i voli indicano voli in ritardo del giorno precedente)</span></span>
<span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>n_early <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">dep_time</span> <span class="op">&lt;</span> <span class="fl">500</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day n_early</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1       0</span></span>
<span><span class="co">#&gt; 2  2013     1     2       3</span></span>
<span><span class="co">#&gt; 3  2013     1     3       4</span></span>
<span><span class="co">#&gt; 4  2013     1     4       3</span></span>
<span><span class="co">#&gt; 5  2013     1     5       3</span></span>
<span><span class="co">#&gt; 6  2013     1     6       2</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span>
<span></span>
<span><span class="co"># Quale percentuale di voli è in ritardo di più di un'ora?</span></span>
<span><span class="va">not_cancelled</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>hour_prop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">arr_delay</span> <span class="op">&gt;</span> <span class="fl">60</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day hour_prop</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1    0.0722</span></span>
<span><span class="co">#&gt; 2  2013     1     2    0.0851</span></span>
<span><span class="co">#&gt; 3  2013     1     3    0.0567</span></span>
<span><span class="co">#&gt; 4  2013     1     4    0.0396</span></span>
<span><span class="co">#&gt; 5  2013     1     5    0.0349</span></span>
<span><span class="co">#&gt; 6  2013     1     6    0.0470</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span></code></pre></div>
</li>
</ul>
</div>
<div id="raggruppare-per-variabili-multiple" class="section level3" number="5.6.5">
<h3>
<span class="header-section-number">5.6.5</span> Raggruppare per variabili multiple<a class="anchor" aria-label="anchor" href="#raggruppare-per-variabili-multiple"><i class="fas fa-link"></i></a>
</h3>
<p>Quando si raggruppa per variabili multiple, ogni riepilogo si stacca da un livello del raggruppamento. Questo rende facile arrotolare progressivamente un set di dati:</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">daily</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">flights</span>, <span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">per_day</span>   <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">daily</span>, flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year', 'month'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 365 × 4</span></span>
<span><span class="co">#&gt; # Groups:   year, month [12]</span></span>
<span><span class="co">#&gt;    year month   day flights</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1     842</span></span>
<span><span class="co">#&gt; 2  2013     1     2     943</span></span>
<span><span class="co">#&gt; 3  2013     1     3     914</span></span>
<span><span class="co">#&gt; 4  2013     1     4     915</span></span>
<span><span class="co">#&gt; 5  2013     1     5     720</span></span>
<span><span class="co">#&gt; 6  2013     1     6     832</span></span>
<span><span class="co">#&gt; # … with 359 more rows</span></span>
<span><span class="op">(</span><span class="va">per_month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">per_day</span>, flights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'year'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span><span class="co">#&gt; # A tibble: 12 × 3</span></span>
<span><span class="co">#&gt; # Groups:   year [1]</span></span>
<span><span class="co">#&gt;    year month flights</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1   27004</span></span>
<span><span class="co">#&gt; 2  2013     2   24951</span></span>
<span><span class="co">#&gt; 3  2013     3   28834</span></span>
<span><span class="co">#&gt; 4  2013     4   28330</span></span>
<span><span class="co">#&gt; 5  2013     5   28796</span></span>
<span><span class="co">#&gt; 6  2013     6   28243</span></span>
<span><span class="co">#&gt; # … with 6 more rows</span></span>
<span><span class="op">(</span><span class="va">per_year</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="va">per_month</span>, flights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">flights</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;    year flights</span></span>
<span><span class="co">#&gt;   &lt;int&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013  336776</span></span></code></pre></div>
<p>Fate attenzione quando concatenate progressivamente i sommari: va bene per le somme e i conteggi, ma dovete pensare alla ponderazione di medie e varianze, e non è possibile farlo esattamente per le statistiche basate sui ranghi come la mediana. In altre parole, la somma delle somme per gruppi è la somma complessiva, ma la mediana delle mediane per gruppi non è la mediana complessiva.</p>
</div>
<div id="de-raggruppamento" class="section level3" number="5.6.6">
<h3>
<span class="header-section-number">5.6.6</span> De-raggruppamento<a class="anchor" aria-label="anchor" href="#de-raggruppamento"><i class="fas fa-link"></i></a>
</h3>
<p>Se avete bisogno di rimuovere il raggruppamento e tornare alle operazioni su dati non raggruppati, usate <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup()</a></code>.</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">daily</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span>             <span class="co"># no longer grouped by date</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>flights <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>  <span class="co"># all flights</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 1</span></span>
<span><span class="co">#&gt;   flights</span></span>
<span><span class="co">#&gt;     &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  336776</span></span></code></pre></div>
</div>
<div id="esercizi-12" class="section level3" number="5.6.7">
<h3>
<span class="header-section-number">5.6.7</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-12"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Cerca almeno 5 modi diversi per valutare le caratteristiche di ritardo tipiche di un gruppo di voli.
Considera i seguenti scenari:</p>
<ul>
<li><p>Un volo è in anticipo di 15 minuti il 50% delle volte, e in ritardo di 15 minuti il 50% delle volte.
delle volte.</p></li>
<li><p>Un volo è sempre in ritardo di 10 minuti.</p></li>
<li><p>Un volo è 30 minuti in anticipo il 50% del tempo e 30 minuti in ritardo il 50% del tempo.
delle volte.</p></li>
<li><p>Il 99% delle volte un volo è in orario. L’1% delle volte è in ritardo di 2 ore.</p></li>
</ul>
<p>Cos’è più importante: il ritardo di arrivo o il ritardo di partenza?</p>
</li>
<li><p>Trovate un altro approccio che vi dia lo stesso risultato di
<code>not_cancelled %&gt;% count(dest)</code> e
<code>not_cancelled %&gt;% count(tailnum, wt = distance)</code> (senza usare
<code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code>).</p></li>
<li><p>La nostra definizione di voli cancellati (<code>is.na(dep_delay) | is.na(arr_delay)</code>
) è leggermente subottimale. Perché? Qual è la colonna più importante?</p></li>
<li><p>Guarda il numero di voli cancellati al giorno. C’è un modello sottostante?
La proporzione di voli cancellati è legata al ritardo medio?</p></li>
<li><p>Quale compagnia ha i peggiori ritardi? Sfida: puoi distinguere gli effetti
effetti dei cattivi aeroporti rispetto alle cattive compagnie? Perché/perché no? (Suggerimento: pensa a
<code>flights %&gt;% group_by(carrier, dest) %&gt;% summarise(n())</code>)</p></li>
<li><p>Cosa fa l’argomento <code>sort</code> di <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code>. Quando potreste usarlo?</p></li>
</ol>
</div>
</div>
<div id="mutazioni-raggruppate-e-filtri" class="section level2" number="5.7">
<h2>
<span class="header-section-number">5.7</span> Mutazioni raggruppate (e filtri)<a class="anchor" aria-label="anchor" href="#mutazioni-raggruppate-e-filtri"><i class="fas fa-link"></i></a>
</h2>
<p>Il raggruppamento è molto utile insieme a <code><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise()</a></code>, ma si possono anche fare operazioni convenienti con <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/filter.html">filter()</a></code>:</p>
<ul>
<li>
<p>Trova i peggiori membri di ogni gruppo:</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights_sml</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html">rank</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html">desc</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3,306 × 7</span></span>
<span><span class="co">#&gt; # Groups:   year, month, day [365]</span></span>
<span><span class="co">#&gt;    year month   day dep_delay arr_delay distance air_time</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1       853       851      184       41</span></span>
<span><span class="co">#&gt; 2  2013     1     1       290       338     1134      213</span></span>
<span><span class="co">#&gt; 3  2013     1     1       260       263      266       46</span></span>
<span><span class="co">#&gt; 4  2013     1     1       157       174      213       60</span></span>
<span><span class="co">#&gt; 5  2013     1     1       216       222      708      121</span></span>
<span><span class="co">#&gt; 6  2013     1     1       255       250      589      115</span></span>
<span><span class="co">#&gt; # … with 3,300 more rows</span></span></code></pre></div>
</li>
<li>
<p>Trova tutti i gruppi più grandi di una soglia:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">popular_dests</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">365</span><span class="op">)</span></span>
<span><span class="va">popular_dests</span></span>
<span><span class="co">#&gt; # A tibble: 332,577 × 19</span></span>
<span><span class="co">#&gt; # Groups:   dest [77]</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      517         515       2     830     819      11 UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      533         529       4     850     830      20 UA     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      544         545      -1    1004    1022     -18 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; # … with 332,571 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
</li>
<li>
<p>Standardizzare per calcolare le metriche per gruppo:</p>
<div class="sourceCode" id="cb123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">popular_dests</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">arr_delay</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prop_delay <span class="op">=</span> <span class="va">arr_delay</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">arr_delay</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">day</span>, <span class="va">dest</span>, <span class="va">arr_delay</span>, <span class="va">prop_delay</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 131,106 × 6</span></span>
<span><span class="co">#&gt; # Groups:   dest [77]</span></span>
<span><span class="co">#&gt;    year month   day dest  arr_delay prop_delay</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;     &lt;dbl&gt;      &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1 IAH          11  0.000111 </span></span>
<span><span class="co">#&gt; 2  2013     1     1 IAH          20  0.000201 </span></span>
<span><span class="co">#&gt; 3  2013     1     1 MIA          33  0.000235 </span></span>
<span><span class="co">#&gt; 4  2013     1     1 ORD          12  0.0000424</span></span>
<span><span class="co">#&gt; 5  2013     1     1 FLL          19  0.0000938</span></span>
<span><span class="co">#&gt; 6  2013     1     1 ORD           8  0.0000283</span></span>
<span><span class="co">#&gt; # … with 131,100 more rows</span></span></code></pre></div>
</li>
</ul>
<p>Un filtro raggruppato è una mutazione raggruppata seguita da un filtro non raggruppato. Generalmente li evito tranne che per manipolazioni rapide e sporche: altrimenti è difficile controllare di aver fatto la manipolazione correttamente.</p>
<p>Le funzioni che funzionano più naturalmente nei mutate raggruppati e nei filtri sono note come funzioni finestra (rispetto alle funzioni di sintesi usate per i sommari). Puoi imparare di più sulle utili funzioni finestra nella vignetta corrispondente: <code><a href="https://dplyr.tidyverse.org/articles/window-functions.html">vignette("window-functions")</a></code>.</p>
<div id="esercizi-13" class="section level3" number="5.7.1">
<h3>
<span class="header-section-number">5.7.1</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-13"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Fai riferimento alle liste di funzioni utili per mutare e filtrare.
Descrivete come cambia ogni operazione quando la combinate con il raggruppamento.</p></li>
<li><p>Quale aereo (<code>tailnum</code>) ha il peggior record di puntualità?</p></li>
<li><p>A che ora del giorno dovresti volare se vuoi evitare il più possibile i ritardi?
possibile?</p></li>
<li><p>Per ogni destinazione, calcola i minuti totali di ritardo. Per ogni
volo, calcola la proporzione del ritardo totale per la sua destinazione.</p></li>
<li><p>I ritardi sono tipicamente correlati temporalmente: anche una volta che il problema che
il problema che ha causato il ritardo iniziale è stato risolto, i voli successivi sono ritardati
per permettere ai voli precedenti di partire. Utilizzando <code>lag()</code>, esplorate come il ritardo
di un volo sia correlato al ritardo del volo immediatamente precedente.</p></li>
<li><p>Guarda ogni destinazione. Potete trovare voli che sono sospettosamente
veloci? (cioè voli che rappresentano un potenziale errore di inserimento dati). 2. Calcola
il tempo di volo di un volo rispetto al volo più breve per quella destinazione.
Quali voli hanno subito più ritardi in volo?</p></li>
<li><p>Trova tutte le destinazioni che sono volate da almeno due compagnie. Usa questa
informazioni per classificare i vettori.</p></li>
<li><p>Per ogni aereo, conti il numero di voli prima del primo ritardo
superiore a 1 ora.</p></li>
</ol>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="workflow-basi.html"><span class="header-section-number">4</span> Workflow: basi</a></div>
<div class="next"><a href="workflow-script.html"><span class="header-section-number">6</span> Workflow: script</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#transform"><span class="header-section-number">5</span> Trasformazione</a></li>
<li>
<a class="nav-link" href="#introduzione-2"><span class="header-section-number">5.1</span> Introduzione</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#prerequisiti-2"><span class="header-section-number">5.1.1</span> Prerequisiti</a></li>
<li><a class="nav-link" href="#nycflights13"><span class="header-section-number">5.1.2</span> nycflights13</a></li>
<li><a class="nav-link" href="#basi-del-dplyr"><span class="header-section-number">5.1.3</span> Basi del dplyr</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#filtrare-le-righe-con-filter"><span class="header-section-number">5.2</span> Filtrare le righe con filter()</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#confronti"><span class="header-section-number">5.2.1</span> Confronti</a></li>
<li><a class="nav-link" href="#operatori-logici"><span class="header-section-number">5.2.2</span> Operatori logici</a></li>
<li><a class="nav-link" href="#valori-mancanti"><span class="header-section-number">5.2.3</span> Valori mancanti</a></li>
<li><a class="nav-link" href="#esercizi-8"><span class="header-section-number">5.2.4</span> Esercizi</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#organizzare-le-righe-con-arrange"><span class="header-section-number">5.3</span> Organizzare le righe con arrange()</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#esercizi-9"><span class="header-section-number">5.3.1</span> Esercizi</a></li></ul>
</li>
<li>
<a class="nav-link" href="#select"><span class="header-section-number">5.4</span> Seleziona le colonne con select()</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#esercizi-10"><span class="header-section-number">5.4.1</span> Esercizi</a></li></ul>
</li>
<li>
<a class="nav-link" href="#aggiungere-nuove-variabili-con-mutate"><span class="header-section-number">5.5</span> Aggiungere nuove variabili con mutate()</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#mutate-funs"><span class="header-section-number">5.5.1</span> Funzioni utili per creare variabili</a></li>
<li><a class="nav-link" href="#esercizi-11"><span class="header-section-number">5.5.2</span> Esercizi</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#summary-funs"><span class="header-section-number">5.6</span> Riassunti raggruppati con summarise()</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#combinare-pi%C3%B9-operazioni-con-la-pipe"><span class="header-section-number">5.6.1</span> Combinare più operazioni con la ‘pipe’</a></li>
<li><a class="nav-link" href="#valori-mancanti-1"><span class="header-section-number">5.6.2</span> Valori mancanti</a></li>
<li><a class="nav-link" href="#dati-di-conteggio"><span class="header-section-number">5.6.3</span> Dati di conteggio</a></li>
<li><a class="nav-link" href="#summarise-funs"><span class="header-section-number">5.6.4</span> Funzioni di riepilogo utili</a></li>
<li><a class="nav-link" href="#raggruppare-per-variabili-multiple"><span class="header-section-number">5.6.5</span> Raggruppare per variabili multiple</a></li>
<li><a class="nav-link" href="#de-raggruppamento"><span class="header-section-number">5.6.6</span> De-raggruppamento</a></li>
<li><a class="nav-link" href="#esercizi-12"><span class="header-section-number">5.6.7</span> Esercizi</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#mutazioni-raggruppate-e-filtri"><span class="header-section-number">5.7</span> Mutazioni raggruppate (e filtri)</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#esercizi-13"><span class="header-section-number">5.7.1</span> Esercizi</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/lucavd/r4ds_ita_1st_ed/blob/master/transform.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/lucavd/r4ds_ita_1st_ed/edit/master/transform.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R for Data Science - edizione italiana</strong>" was written by Hadley Wickham e Garrett Grolemund. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
