<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>13 Dati relazionali | R for Data Science - edizione italiana</title>
<meta name="author" content="Hadley Wickham e Garrett Grolemund">
<meta name="description" content="13.1 Introduzione È raro che un’analisi dei dati coinvolga solo una singola tabella di dati. Tipicamente si hanno molte tabelle di dati, e bisogna combinarle per rispondere alle domande che...">
<meta name="generator" content="bookdown 0.32.1 with bs4_book()">
<meta property="og:title" content="13 Dati relazionali | R for Data Science - edizione italiana">
<meta property="og:type" content="book">
<meta property="og:url" content="http://it.r4ds.hadley.nz/dati-relazionali.html">
<meta property="og:image" content="http://it.r4ds.hadley.nz/cover.png">
<meta property="og:description" content="13.1 Introduzione È raro che un’analisi dei dati coinvolga solo una singola tabella di dati. Tipicamente si hanno molte tabelle di dati, e bisogna combinarle per rispondere alle domande che...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="13 Dati relazionali | R for Data Science - edizione italiana">
<meta name="twitter:site" content="@lucavd">
<meta name="twitter:description" content="13.1 Introduzione È raro che un’analisi dei dati coinvolga solo una singola tabella di dati. Tipicamente si hanno molte tabelle di dati, e bisogna combinarle per rispondere alle domande che...">
<meta name="twitter:image" content="http://it.r4ds.hadley.nz/cover.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2.9000/transition.js"></script><script src="libs/bs3compat-0.4.2.9000/tabs.js"></script><script src="libs/bs3compat-0.4.2.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.1/htmlwidgets.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.1/leaflet.js"></script><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-115082821-1');
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">R for Data Science - edizione italiana</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Benvenuto</a></li>
<li><a class="" href="introduzione.html"><span class="header-section-number">1</span> Introduzione</a></li>
<li class="book-part">Esplora</li>
<li><a class="" href="explore-intro.html"><span class="header-section-number">2</span> Introduzione</a></li>
<li><a class="" href="visualizzazione.html"><span class="header-section-number">3</span> Visualizzazione</a></li>
<li><a class="" href="workflow-basi.html"><span class="header-section-number">4</span> Workflow: basi</a></li>
<li><a class="" href="transform.html"><span class="header-section-number">5</span> Trasformazione</a></li>
<li><a class="" href="workflow-script.html"><span class="header-section-number">6</span> Workflow: script</a></li>
<li><a class="" href="analisi-esplorativa.html"><span class="header-section-number">7</span> Analisi esplorativa</a></li>
<li><a class="" href="workflow-progetti.html"><span class="header-section-number">8</span> Workflow: progetti</a></li>
<li class="book-part">Wrangle</li>
<li><a class="" href="wrangle-intro.html"><span class="header-section-number">9</span> Introduzione</a></li>
<li><a class="" href="tibble.html"><span class="header-section-number">10</span> Tibble</a></li>
<li><a class="" href="importazione-dei-dati.html"><span class="header-section-number">11</span> Importazione dei dati</a></li>
<li><a class="" href="tidy-data.html"><span class="header-section-number">12</span> Tidy data</a></li>
<li><a class="active" href="dati-relazionali.html"><span class="header-section-number">13</span> Dati relazionali</a></li>
<li><a class="" href="stringhe.html"><span class="header-section-number">14</span> Stringhe</a></li>
<li><a class="" href="fattori.html"><span class="header-section-number">15</span> Fattori</a></li>
<li><a class="" href="date-e-tempi.html"><span class="header-section-number">16</span> Date e tempi</a></li>
<li class="book-part">Programmare</li>
<li><a class="" href="program-intro.html"><span class="header-section-number">17</span> Introduzione</a></li>
<li><a class="" href="pipe.html"><span class="header-section-number">18</span> Pipe</a></li>
<li><a class="" href="funzioni.html"><span class="header-section-number">19</span> Funzioni</a></li>
<li><a class="" href="vettori.html"><span class="header-section-number">20</span> Vettori</a></li>
<li><a class="" href="iterazioni.html"><span class="header-section-number">21</span> Iterazioni</a></li>
<li class="book-part">Model</li>
<li><a class="" href="model-intro.html"><span class="header-section-number">22</span> Introduzione</a></li>
<li><a class="" href="modelli-base.html"><span class="header-section-number">23</span> Modelli base</a></li>
<li><a class="" href="costruire-modelli.html"><span class="header-section-number">24</span> Costruire modelli</a></li>
<li><a class="" href="molti-modelli.html"><span class="header-section-number">25</span> Molti modelli</a></li>
<li class="book-part">Comunicare</li>
<li><a class="" href="communicate-intro.html"><span class="header-section-number">26</span> Introduzione</a></li>
<li><a class="" href="r-markdown.html"><span class="header-section-number">27</span> R Markdown</a></li>
<li><a class="" href="grafici-per-la-comunicazione.html"><span class="header-section-number">28</span> Grafici per la comunicazione</a></li>
<li><a class="" href="formati-di-r-markdown.html"><span class="header-section-number">29</span> Formati di R Markdown</a></li>
<li><a class="" href="r-markdown-workflow.html"><span class="header-section-number">30</span> R Markdown workflow</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/lucavd/r4ds_ita_1st_ed">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="dati-relazionali" class="section level1" number="13">
<h1>
<span class="header-section-number">13</span> Dati relazionali<a class="anchor" aria-label="anchor" href="#dati-relazionali"><i class="fas fa-link"></i></a>
</h1>
<div id="introduzione-7" class="section level2" number="13.1">
<h2>
<span class="header-section-number">13.1</span> Introduzione<a class="anchor" aria-label="anchor" href="#introduzione-7"><i class="fas fa-link"></i></a>
</h2>
<p>È raro che un’analisi dei dati coinvolga solo una singola tabella di dati. Tipicamente si hanno molte tabelle di dati, e bisogna combinarle per rispondere alle domande che interessano. Collettivamente, più tabelle di dati sono chiamate <strong>dati relazionali</strong> perché sono importanti le relazioni, non solo i singoli insiemi di dati.</p>
<p>Le relazioni sono sempre definite tra una coppia di tabelle. Tutte le altre relazioni sono costruite a partire da questa semplice idea: le relazioni di tre o più tabelle sono sempre una proprietà delle relazioni tra ogni coppia. A volte entrambi gli elementi di una coppia possono essere la stessa tabella! Questo è necessario se, per esempio, avete una tabella di persone, e ogni persona ha un riferimento ai suoi genitori.</p>
<p>Per lavorare con i dati relazionali avete bisogno di verbi che lavorino con coppie di tabelle. Ci sono tre famiglie di verbi progettati per lavorare con i dati relazionali:</p>
<ul>
<li><p><strong>Mutating joins</strong>, che aggiungono nuove variabili ad un frame di dati dalla corrispondenza
osservazioni in un altro.</p></li>
<li><p><strong>Filtering joins</strong>, che filtrano le osservazioni di un frame di dati in base
se corrispondono o meno ad un’osservazione nell’altra tabella.</p></li>
<li><p><strong>Operazioni di set</strong>, che trattano le osservazioni come se fossero elementi di un set.</p></li>
</ul>
<p>Il posto più comune per trovare dati relazionali è in un <em>sistema di gestione di database relazionali</em> (o RDBMS), un termine che comprende quasi tutti i moderni database. Se avete usato un database prima, avete quasi certamente usato SQL. Se è così, i concetti di questo capitolo dovrebbero esservi familiari, anche se la loro espressione in dplyr è un po’ diversa. In generale, dplyr è un po’ più facile da usare di SQL perché dplyr è specializzato nell’analisi dei dati: rende più facili le comuni operazioni di analisi dei dati, a spese di rendere più difficile fare altre cose che non sono comunemente necessarie per l’analisi dei dati.</p>
<div id="prerequisiti-7" class="section level3" number="13.1.1">
<h3>
<span class="header-section-number">13.1.1</span> Prerequisiti<a class="anchor" aria-label="anchor" href="#prerequisiti-7"><i class="fas fa-link"></i></a>
</h3>
<p>Esploreremo i dati relazionali di <code>nycflights13</code> usando i verbi a due tabelle di dplyr.</p>
<div class="sourceCode" id="cb257"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/nycflights13">nycflights13</a></span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="nycflights13-relational" class="section level2" number="13.2">
<h2>
<span class="header-section-number">13.2</span> nycflights13<a class="anchor" aria-label="anchor" href="#nycflights13-relational"><i class="fas fa-link"></i></a>
</h2>
<p>Useremo il pacchetto nycflights13 per imparare i dati relazionali. nycflights13 contiene quattro tibbie che sono collegate alla tabella <code>flights</code> che avete usato in <a href="transform.html#transform">trasformazione</a>:</p>
<ul>
<li>
<p><code>airlines</code> ti permette di cercare il nome completo del vettore dal suo codice abbreviato:</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">airlines</span></span>
<span><span class="co">#&gt; # A tibble: 16 × 2</span></span>
<span><span class="co">#&gt;   carrier name                    </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;chr&gt;                   </span></span>
<span><span class="co">#&gt; 1 9E      Endeavor Air Inc.       </span></span>
<span><span class="co">#&gt; 2 AA      American Airlines Inc.  </span></span>
<span><span class="co">#&gt; 3 AS      Alaska Airlines Inc.    </span></span>
<span><span class="co">#&gt; 4 B6      JetBlue Airways         </span></span>
<span><span class="co">#&gt; 5 DL      Delta Air Lines Inc.    </span></span>
<span><span class="co">#&gt; 6 EV      ExpressJet Airlines Inc.</span></span>
<span><span class="co">#&gt; # … with 10 more rows</span></span></code></pre></div>
</li>
<li>
<p><code>airports</code> dà informazioni su ogni aeroporto, identificato dal codice aeroportuale <code>faa</code>:</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">airports</span></span>
<span><span class="co">#&gt; # A tibble: 1,458 × 8</span></span>
<span><span class="co">#&gt;   faa   name                             lat   lon   alt    tz dst   tzone      </span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;                          &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;      </span></span>
<span><span class="co">#&gt; 1 04G   Lansdowne Airport               41.1 -80.6  1044    -5 A     America/Ne…</span></span>
<span><span class="co">#&gt; 2 06A   Moton Field Municipal Airport   32.5 -85.7   264    -6 A     America/Ch…</span></span>
<span><span class="co">#&gt; 3 06C   Schaumburg Regional             42.0 -88.1   801    -6 A     America/Ch…</span></span>
<span><span class="co">#&gt; 4 06N   Randall Airport                 41.4 -74.4   523    -5 A     America/Ne…</span></span>
<span><span class="co">#&gt; 5 09J   Jekyll Island Airport           31.1 -81.4    11    -5 A     America/Ne…</span></span>
<span><span class="co">#&gt; 6 0A9   Elizabethton Municipal Airport  36.4 -82.2  1593    -5 A     America/Ne…</span></span>
<span><span class="co">#&gt; # … with 1,452 more rows</span></span></code></pre></div>
</li>
<li>
<p><code>planes</code> dà informazioni su ogni aereo, identificato dal suo <code>tailnum</code>:</p>
<div class="sourceCode" id="cb260"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">planes</span></span>
<span><span class="co">#&gt; # A tibble: 3,322 × 9</span></span>
<span><span class="co">#&gt;   tailnum  year type                    manuf…¹ model engines seats speed engine</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;int&gt; &lt;chr&gt;                   &lt;chr&gt;   &lt;chr&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt; </span></span>
<span><span class="co">#&gt; 1 N10156   2004 Fixed wing multi engine EMBRAER EMB-…       2    55    NA Turbo…</span></span>
<span><span class="co">#&gt; 2 N102UW   1998 Fixed wing multi engine AIRBUS… A320…       2   182    NA Turbo…</span></span>
<span><span class="co">#&gt; 3 N103US   1999 Fixed wing multi engine AIRBUS… A320…       2   182    NA Turbo…</span></span>
<span><span class="co">#&gt; 4 N104UW   1999 Fixed wing multi engine AIRBUS… A320…       2   182    NA Turbo…</span></span>
<span><span class="co">#&gt; 5 N10575   2002 Fixed wing multi engine EMBRAER EMB-…       2    55    NA Turbo…</span></span>
<span><span class="co">#&gt; 6 N105UW   1999 Fixed wing multi engine AIRBUS… A320…       2   182    NA Turbo…</span></span>
<span><span class="co">#&gt; # … with 3,316 more rows, and abbreviated variable name ¹​manufacturer</span></span></code></pre></div>
</li>
<li>
<p><code>weather</code> dà il meteo in ogni aeroporto di NYC per ogni ora:</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">weather</span></span>
<span><span class="co">#&gt; # A tibble: 26,115 × 15</span></span>
<span><span class="co">#&gt;   origin  year month   day  hour  temp  dewp humid wind_dir wind_speed wind_gust</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 EWR     2013     1     1     1  39.0  26.1  59.4      270      10.4         NA</span></span>
<span><span class="co">#&gt; 2 EWR     2013     1     1     2  39.0  27.0  61.6      250       8.06        NA</span></span>
<span><span class="co">#&gt; 3 EWR     2013     1     1     3  39.0  28.0  64.4      240      11.5         NA</span></span>
<span><span class="co">#&gt; 4 EWR     2013     1     1     4  39.9  28.0  62.2      250      12.7         NA</span></span>
<span><span class="co">#&gt; 5 EWR     2013     1     1     5  39.0  28.0  64.4      260      12.7         NA</span></span>
<span><span class="co">#&gt; 6 EWR     2013     1     1     6  37.9  28.0  67.2      240      11.5         NA</span></span>
<span><span class="co">#&gt; # … with 26,109 more rows, and 4 more variables: precip &lt;dbl&gt;, pressure &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   visib &lt;dbl&gt;, time_hour &lt;dttm&gt;</span></span></code></pre></div>
</li>
</ul>
<p>Un modo per mostrare le relazioni tra le diverse tabelle è un disegno:</p>
<div class="inline-figure"><img src="diagrams/relational-nycflights.png" width="70%" style="display: block; margin: auto;"></div>
<p>Questo diagramma è un po’ travolgente, ma è semplice rispetto ad alcuni che vedrete in natura! La chiave per capire diagrammi come questo è ricordare che ogni relazione riguarda sempre una coppia di tabelle. Non c’è bisogno di capire tutto, basta capire la catena di relazioni tra le tabelle a cui si è interessati.</p>
<p>Per nycflights13:</p>
<ul>
<li><p><code>flights</code> si connette a <code>planes</code> attraverso una singola variabile, <code>tailnum</code>.</p></li>
<li><p><code>flights</code> si connette a <code>airlines</code> attraverso la variabile <code>carrier</code>.</p></li>
<li><p><code>flights</code> si connette a <code>airports</code> in due modi: attraverso le variabili <code>origin</code> e
<code>dest</code>.</p></li>
<li><p>I voli si connettono al meteo attraverso la variabile <code>origin</code> (la località), e
<code>year</code>, <code>month</code>, <code>day</code> e <code>hour</code> (il tempo).</p></li>
</ul>
<div id="esercizi-28" class="section level3" number="13.2.1">
<h3>
<span class="header-section-number">13.2.1</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-28"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Immagina di voler disegnare (approssimativamente) la rotta che ogni aereo vola da
sua origine alla sua destinazione. Di quali variabili avresti bisogno? Quali tabelle
avreste bisogno di combinare?</p></li>
<li><p>Ho dimenticato di disegnare la relazione tra <code>weather</code> e <code>airports</code>.
Qual è la relazione e come dovrebbe apparire nel diagramma?</p></li>
<li><p><code>weather</code> contiene solo informazioni per gli aeroporti di origine (NYC). Se
contenesse le informazioni meteo per tutti gli aeroporti degli USA, quale ulteriore
relazione aggiuntiva definirebbe con <code>flights</code>?</p></li>
<li><p>Sappiamo che alcuni giorni dell’anno sono “speciali”, e meno persone del
persone del solito volano in quei giorni. Come potresti rappresentare questi dati come un frame di dati?
Quali sarebbero le chiavi primarie di quella tabella? Come si connetterebbe alle
tabelle esistenti?</p></li>
</ol>
</div>
</div>
<div id="chiavi" class="section level2" number="13.3">
<h2>
<span class="header-section-number">13.3</span> Chiavi<a class="anchor" aria-label="anchor" href="#chiavi"><i class="fas fa-link"></i></a>
</h2>
<p>Le variabili usate per collegare ogni coppia di tabelle sono chiamate <strong>chiavi</strong>. Una chiave è una variabile (o un insieme di variabili) che identifica univocamente un’osservazione. In casi semplici, una singola variabile è sufficiente per identificare un’osservazione. Per esempio, ogni piano è identificato univocamente dal suo <code>tailnum</code>. In altri casi, possono essere necessarie più variabili. Per esempio, per identificare un’osservazione in <code>weather</code> sono necessarie cinque variabili: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code> e <code>origin</code>.</p>
<p>Ci sono due tipi di chiavi:</p>
<ul>
<li><p>Una <strong>chiave primaria</strong> identifica univocamente un’osservazione nella propria tabella.
Per esempio, <code>planes$tailnum</code> è una chiave primaria perché identifica univocamente
ogni aereo nella tabella <code>planes</code>.</p></li>
<li><p>Una <strong>chiave esterna</strong> identifica univocamente un’osservazione in un’altra tabella.
Per esempio, <code>flights$tailnum</code> è una chiave esterna perché appare nella tabella
tabella <code>flights</code> dove corrisponde ad ogni volo ad un unico aereo.</p></li>
</ul>
<p>Una variabile può essere sia una chiave primaria <em>e</em> una chiave esterna. Per esempio, <code>origin</code> fa parte della chiave primaria <code>weather</code> ed è anche una chiave esterna per la tabella <code>airports</code>.</p>
<p>Una volta che hai identificato le chiavi primarie nelle tue tabelle, è una buona pratica verificare che esse identifichino davvero in modo univoco ogni osservazione. Un modo per farlo è quello di <code><a href="https://dplyr.tidyverse.org/reference/count.html">count()</a></code> le chiavi primarie e cercare le voci dove <code>n</code> è maggiore di uno:</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">planes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">tailnum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 2</span></span>
<span><span class="co">#&gt; # … with 2 variables: tailnum &lt;chr&gt;, n &lt;int&gt;</span></span>
<span></span>
<span><span class="va">weather</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">hour</span>, <span class="va">origin</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 6</span></span>
<span><span class="co">#&gt;    year month   day  hour origin     n</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013    11     3     1 EWR        2</span></span>
<span><span class="co">#&gt; 2  2013    11     3     1 JFK        2</span></span>
<span><span class="co">#&gt; 3  2013    11     3     1 LGA        2</span></span></code></pre></div>
<p>A volte una tabella non ha una chiave primaria esplicita: ogni riga è un’osservazione, ma nessuna combinazione di variabili la identifica in modo affidabile. Per esempio, qual è la chiave primaria nella tabella <code>flights</code>? Si potrebbe pensare che sia la data più il numero di volo o di coda, ma nessuno dei due è unico:</p>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">flight</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 29,768 × 5</span></span>
<span><span class="co">#&gt;    year month   day flight     n</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1      1     2</span></span>
<span><span class="co">#&gt; 2  2013     1     1      3     2</span></span>
<span><span class="co">#&gt; 3  2013     1     1      4     2</span></span>
<span><span class="co">#&gt; 4  2013     1     1     11     3</span></span>
<span><span class="co">#&gt; 5  2013     1     1     15     2</span></span>
<span><span class="co">#&gt; 6  2013     1     1     21     2</span></span>
<span><span class="co">#&gt; # … with 29,762 more rows</span></span>
<span></span>
<span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">month</span>, <span class="va">day</span>, <span class="va">tailnum</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 64,928 × 5</span></span>
<span><span class="co">#&gt;    year month   day tailnum     n</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1 N0EGMQ      2</span></span>
<span><span class="co">#&gt; 2  2013     1     1 N11189      2</span></span>
<span><span class="co">#&gt; 3  2013     1     1 N11536      2</span></span>
<span><span class="co">#&gt; 4  2013     1     1 N11544      3</span></span>
<span><span class="co">#&gt; 5  2013     1     1 N11551      2</span></span>
<span><span class="co">#&gt; 6  2013     1     1 N12540      2</span></span>
<span><span class="co">#&gt; # … with 64,922 more rows</span></span></code></pre></div>
<p>Quando ho iniziato a lavorare con questi dati, avevo ingenuamente supposto che ogni numero di volo sarebbe stato usato solo una volta al giorno: questo avrebbe reso molto più facile comunicare i problemi con un volo specifico. Purtroppo non è così! Se una tabella manca di una chiave primaria, a volte è utile aggiungerne una con <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> e <code><a href="https://dplyr.tidyverse.org/reference/row_number.html">row_number()</a></code>. Questo rende più facile far combaciare le osservazioni se avete fatto qualche filtraggio e volete ricontrollare i dati originali. Questa è chiamata una _chiave surrogata__.</p>
<p>Una chiave primaria e la corrispondente chiave esterna in un’altra tabella formano una <strong>relazione</strong>. Le relazioni sono tipicamente uno-a-molti. Per esempio, ogni volo ha un aereo, ma ogni aereo ha molti voli. In altri dati, occasionalmente vedrete una relazione 1 a 1. Potete pensare a questo come ad un caso speciale di 1-a-molti. Potete modellare le relazioni molti-a-molti con una relazione molti-a-1 più una relazione 1-a-molti. Per esempio, in questi dati c’è una relazione molti-a-molti tra compagnie aeree e aeroporti: ogni compagnia aerea vola in molti aeroporti; ogni aeroporto ospita molte compagnie aeree.</p>
<div id="esercizi-29" class="section level3" number="13.3.1">
<h3>
<span class="header-section-number">13.3.1</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-29"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Aggiungere una chiave surrogata a <code>flights</code>.</p></li>
<li>
<p>Identifica le chiavi nei seguenti set di dati</p>
<ol style="list-style-type: decimal">
<li>
<code><a href="https://rdrr.io/pkg/Lahman/man/Batting.html">Lahman::Batting</a></code>,</li>
<li>
<code>babynames::babynames</code>.</li>
<li>
<code>nasaweather::atmos</code>.</li>
<li><code>fueleconomy::vehicles</code></li>
<li>
<code><a href="https://ggplot2.tidyverse.org/reference/diamonds.html">ggplot2::diamonds</a></code>.</li>
</ol>
<p>(Potrebbe essere necessario installare alcuni pacchetti e leggere un po’ di documentazione).</p>
</li>
<li>
<p>Disegna un diagramma che illustri le connessioni tra le tabelle <code>Batting</code>,
<code>People</code> e <code>Salaries</code> nel pacchetto Lahman. Disegna un altro diagramma
che mostra la relazione tra <code>People</code>, <code>Managers</code>, <code>AwardsManagers</code>.</p>
<p>Come caratterizzeresti la relazione tra le tabelle <code>Batting</code>,
<code>Pitching</code> e <code>Fielding</code>?</p>
</li>
</ol>
</div>
</div>
<div id="mutating-joins" class="section level2" number="13.4">
<h2>
<span class="header-section-number">13.4</span> Mutating joins<a class="anchor" aria-label="anchor" href="#mutating-joins"><i class="fas fa-link"></i></a>
</h2>
<p>Il primo strumento che vedremo per combinare una coppia di tabelle è la <strong>mutating join</strong>. Una mutating join permette di combinare le variabili di due tabelle. Prima abbina le osservazioni in base alle loro chiavi, poi copia le variabili da una tabella all’altra.</p>
<p>Come <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code>, le funzioni di join aggiungono le variabili a destra, quindi se avete già molte variabili, le nuove variabili non verranno stampate. Per questi esempi, renderemo più facile vedere cosa succede negli esempi creando un set di dati più ristretto:</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights2</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">year</span><span class="op">:</span><span class="va">day</span>, <span class="va">hour</span>, <span class="va">origin</span>, <span class="va">dest</span>, <span class="va">tailnum</span>, <span class="va">carrier</span><span class="op">)</span></span>
<span><span class="va">flights2</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 8</span></span>
<span><span class="co">#&gt;    year month   day  hour origin dest  tailnum carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1     5 EWR    IAH   N14228  UA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1     5 LGA    IAH   N24211  UA     </span></span>
<span><span class="co">#&gt; 3  2013     1     1     5 JFK    MIA   N619AA  AA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1     5 JFK    BQN   N804JB  B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1     6 LGA    ATL   N668DN  DL     </span></span>
<span><span class="co">#&gt; 6  2013     1     1     5 EWR    ORD   N39463  UA     </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span></code></pre></div>
<p>(Ricordate, quando siete in RStudio, potete anche usare <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code> per evitare questo problema).</p>
<p>Immaginate di voler aggiungere il nome completo della compagnia aerea ai dati di <code>flights2</code>. Potete combinare i data frame <code>airlines</code> e <code>flights2</code> con <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code>:</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">origin</span>, <span class="op">-</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airlines</span>, by <span class="op">=</span> <span class="st">"carrier"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 7</span></span>
<span><span class="co">#&gt;    year month   day  hour tailnum carrier name                  </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                 </span></span>
<span><span class="co">#&gt; 1  2013     1     1     5 N14228  UA      United Air Lines Inc. </span></span>
<span><span class="co">#&gt; 2  2013     1     1     5 N24211  UA      United Air Lines Inc. </span></span>
<span><span class="co">#&gt; 3  2013     1     1     5 N619AA  AA      American Airlines Inc.</span></span>
<span><span class="co">#&gt; 4  2013     1     1     5 N804JB  B6      JetBlue Airways       </span></span>
<span><span class="co">#&gt; 5  2013     1     1     6 N668DN  DL      Delta Air Lines Inc.  </span></span>
<span><span class="co">#&gt; 6  2013     1     1     5 N39463  UA      United Air Lines Inc. </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span></code></pre></div>
<p>Il risultato dell’unione delle compagnie aeree a flights2 è una variabile aggiuntiva: <code>name</code>. Questo è il motivo per cui chiamo questo tipo di join un join mutante. In questo caso, avreste potuto arrivare allo stesso punto usando <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> e il subsetting di base di R:</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">origin</span>, <span class="op">-</span><span class="va">dest</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">airlines</span><span class="op">$</span><span class="va">name</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">carrier</span>, <span class="va">airlines</span><span class="op">$</span><span class="va">carrier</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 7</span></span>
<span><span class="co">#&gt;    year month   day  hour tailnum carrier name                  </span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;                 </span></span>
<span><span class="co">#&gt; 1  2013     1     1     5 N14228  UA      United Air Lines Inc. </span></span>
<span><span class="co">#&gt; 2  2013     1     1     5 N24211  UA      United Air Lines Inc. </span></span>
<span><span class="co">#&gt; 3  2013     1     1     5 N619AA  AA      American Airlines Inc.</span></span>
<span><span class="co">#&gt; 4  2013     1     1     5 N804JB  B6      JetBlue Airways       </span></span>
<span><span class="co">#&gt; 5  2013     1     1     6 N668DN  DL      Delta Air Lines Inc.  </span></span>
<span><span class="co">#&gt; 6  2013     1     1     5 N39463  UA      United Air Lines Inc. </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows</span></span></code></pre></div>
<p>Ma questo è difficile da generalizzare quando si ha bisogno di abbinare più variabili, e richiede una lettura attenta per capire l’intento generale.</p>
<p>Le sezioni seguenti spiegano, in dettaglio, come funzionano le mutating joins. Comincerete imparando un’utile rappresentazione visiva delle unioni. Poi la useremo per spiegare le quattro funzioni di mutating join: l’inner join e le tre outer join. Quando si lavora con dati reali, le chiavi non sempre identificano in modo univoco le osservazioni, quindi parleremo di cosa succede quando non c’è una corrispondenza unica. Infine, imparerete come dire a dplyr quali variabili sono le chiavi per una data unione.</p>
<div id="capire-le-unioni" class="section level3" number="13.4.1">
<h3>
<span class="header-section-number">13.4.1</span> Capire le unioni<a class="anchor" aria-label="anchor" href="#capire-le-unioni"><i class="fas fa-link"></i></a>
</h3>
<p>Per aiutarvi ad imparare come funzionano le join, userò una rappresentazione visiva:</p>
<div class="inline-figure"><img src="diagrams/join-setup.png" width="118" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"x1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x2"</span>,</span>
<span>     <span class="fl">3</span>, <span class="st">"x3"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"y1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"y2"</span>,</span>
<span>     <span class="fl">4</span>, <span class="st">"y3"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>La colonna colorata rappresenta la variabile “chiave”: questa è usata per abbinare le righe tra le tabelle. La colonna grigia rappresenta la colonna “valore” che viene portata con sé per il viaggio. In questi esempi mostrerò una singola variabile chiave, ma l’idea si generalizza in modo diretto a chiavi multiple e valori multipli.</p>
<p>Un join è un modo di collegare ogni riga in <code>x</code> a zero, una o più righe in <code>y</code>. Il diagramma seguente mostra ogni potenziale corrispondenza come un’intersezione di una coppia di linee.</p>
<div class="inline-figure"><img src="diagrams/join-setup2.png" width="166" style="display: block; margin: auto;"></div>
<p>(Se guardate attentamente, potreste notare che abbiamo cambiato l’ordine delle colonne chiave e valore in <code>x</code>. Questo è per enfatizzare che i join corrispondono in base alla chiave; il valore è solo portato con sé per il viaggio).</p>
<p>In un vero join, le corrispondenze saranno indicate con dei punti. Il numero di punti = il numero di corrispondenze = il numero di righe nell’output.</p>
<div class="inline-figure"><img src="diagrams/join-inner.png" width="338" style="display: block; margin: auto;"></div>
</div>
<div id="inner-join" class="section level3" number="13.4.2">
<h3>
<span class="header-section-number">13.4.2</span> Inner join<a class="anchor" aria-label="anchor" href="#inner-join"><i class="fas fa-link"></i></a>
</h3>
<p>Il tipo più semplice di join è l’<strong>inner join</strong>. Un join interno abbina coppie di osservazioni ogni volta che le loro chiavi sono uguali:</p>
<div class="inline-figure"><img src="diagrams/join-inner.png" width="338" style="display: block; margin: auto;"></div>
<p>(Per essere precisi, questa è una <strong>equijoin</strong> interna perché le chiavi sono abbinate usando l’operatore di uguaglianza. Dato che la maggior parte delle unioni sono equijoin, di solito lasciamo perdere questa specificazione).</p>
<p>L’output di un join interno è un nuovo data frame che contiene la chiave, i valori x e i valori y. Usiamo <code>by</code> per dire a dplyr quale variabile è la chiave:</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">inner_join</a></span><span class="op">(</span><span class="va">y</span>, by <span class="op">=</span> <span class="st">"key"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2</span></span></code></pre></div>
<p>La proprietà più importante di un inner join è che le righe non abbinate non sono incluse nel risultato. Questo significa che generalmente le inner joins non sono appropriate per l’uso in analisi perché è troppo facile perdere osservazioni.</p>
</div>
<div id="outer-join" class="section level3" number="13.4.3">
<h3>
<span class="header-section-number">13.4.3</span> Outer joins<a class="anchor" aria-label="anchor" href="#outer-join"><i class="fas fa-link"></i></a>
</h3>
<p>Un inner join mantiene le osservazioni che appaiono in entrambe le tabelle. Una <strong>outer join</strong> mantiene le osservazioni che appaiono in almeno una delle tabelle. Ci sono tre tipi di outer join:</p>
<ul>
<li>Una <strong>left join</strong> mantiene tutte le osservazioni in <code>x</code>.</li>
<li>Un <strong>joint</strong> a destra mantiene tutte le osservazioni in <code>y</code>.</li>
<li>Un <strong>full join</strong> mantiene tutte le osservazioni in <code>x</code> e <code>y</code>.</li>
</ul>
<p>Questi join funzionano aggiungendo un’osservazione “virtuale” addizionale ad ogni tabella. Questa osservazione ha una chiave che corrisponde sempre (se nessun’altra chiave corrisponde), e un valore riempito con <code>NA</code>.</p>
<p>Graficamente, questo appare come:</p>
<div class="inline-figure"><img src="diagrams/join-outer.png" width="355" style="display: block; margin: auto;"></div>
<p>L’unione più comunemente usata è l’unione a sinistra: la si usa ogni volta che si cercano dati aggiuntivi da un’altra tabella, perché conserva le osservazioni originali anche quando non c’è una corrispondenza. L’unione a sinistra dovrebbe essere la tua unione di default: usala a meno che tu non abbia una forte ragione per preferire una delle altre.</p>
<p>Un altro modo per rappresentare i diversi tipi di join è un diagramma di Venn:</p>
<div class="inline-figure"><img src="diagrams/join-venn.png" width="551" style="display: block; margin: auto;"></div>
<p>Tuttavia, questa non è una grande rappresentazione. Potrebbe rinfrescarvi la memoria su quale join conserva le osservazioni in quale tabella, ma soffre di una grande limitazione: un diagramma di Venn non può mostrare cosa succede quando le chiavi non identificano univocamente un’osservazione.</p>
</div>
<div id="join-matches" class="section level3" number="13.4.4">
<h3>
<span class="header-section-number">13.4.4</span> Chiavi duplicate<a class="anchor" aria-label="anchor" href="#join-matches"><i class="fas fa-link"></i></a>
</h3>
<p>Finora tutti i diagrammi hanno assunto che le chiavi siano uniche. Ma questo non è sempre il caso. Questa sezione spiega cosa succede quando le chiavi non sono uniche. Ci sono due possibilità:</p>
<ol style="list-style-type: decimal">
<li>
<p>Una tabella ha chiavi duplicate. Questo è utile quando vuoi aggiungere ulteriori informazioni, dato che tipicamente c’è una relazione uno-a-molti.</p>
<div class="inline-figure"><img src="diagrams/join-one-to-many.png" width="279" style="display: block; margin: auto;"></div>
<p>Notate che ho messo la colonna chiave in una posizione leggermente diversa nell’output.
Questo riflette il fatto che la chiave è una chiave primaria in <code>y</code> e una chiave esterna in <code>x</code>.</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"x1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x2"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x3"</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"x4"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"y1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"y2"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="st">"key"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 4 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2   </span></span>
<span><span class="co">#&gt; 3     2 x3    y2   </span></span>
<span><span class="co">#&gt; 4     1 x4    y1</span></span></code></pre></div>
</li>
<li>
<p>Entrambe le tabelle hanno chiavi duplicate. Questo è di solito un errore perché in nessuna delle due tabelle le chiavi identificano univocamente un’osservazione. Quando si uniscono chiavi duplicate, si ottengono tutte le combinazioni possibili, il prodotto cartesiano:</p>
<div class="inline-figure"><img src="diagrams/join-many-to-many.png" width="342" style="display: block; margin: auto;"></div>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_x</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"x1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x2"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"x3"</span>,</span>
<span>     <span class="fl">3</span>, <span class="st">"x4"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">key</span>, <span class="op">~</span><span class="va">val_y</span>,</span>
<span>     <span class="fl">1</span>, <span class="st">"y1"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"y2"</span>,</span>
<span>     <span class="fl">2</span>, <span class="st">"y3"</span>,</span>
<span>     <span class="fl">3</span>, <span class="st">"y4"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, by <span class="op">=</span> <span class="st">"key"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in left_join(x, y, by = "key"): Each row in `x` is expected to match at most 1 row in `y`.</span></span>
<span><span class="co">#&gt; ℹ Row 2 of `x` matches multiple rows.</span></span>
<span><span class="co">#&gt; ℹ If multiple matches are expected, set `multiple = "all"` to silence this</span></span>
<span><span class="co">#&gt;   warning.</span></span>
<span><span class="co">#&gt; # A tibble: 6 × 3</span></span>
<span><span class="co">#&gt;     key val_x val_y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt;</span></span>
<span><span class="co">#&gt; 1     1 x1    y1   </span></span>
<span><span class="co">#&gt; 2     2 x2    y2   </span></span>
<span><span class="co">#&gt; 3     2 x2    y3   </span></span>
<span><span class="co">#&gt; 4     2 x3    y2   </span></span>
<span><span class="co">#&gt; 5     2 x3    y3   </span></span>
<span><span class="co">#&gt; 6     3 x4    y4</span></span></code></pre></div>
</li>
</ol>
</div>
<div id="join-by" class="section level3" number="13.4.5">
<h3>
<span class="header-section-number">13.4.5</span> Definizione delle colonne chiave<a class="anchor" aria-label="anchor" href="#join-by"><i class="fas fa-link"></i></a>
</h3>
<p>Finora, le coppie di tabelle sono sempre state unite da una singola variabile, e questa variabile ha lo stesso nome in entrambe le tabelle. Questo vincolo è stato codificato da <code>by = "key"</code>. Puoi usare altri valori per <code>by</code> per collegare le tabelle in altri modi:</p>
<ul>
<li>
<p>Il valore predefinito, <code>by = NULL</code>, usa tutte le variabili che appaiono in entrambe le tabelle, il cosiddetto <strong>natural</strong> join. Per esempio, le tabelle dei voli e del meteo corrispondono sulle loro variabili comuni: <code>year</code>, <code>month</code>, <code>day</code>, <code>hour</code> e <code>origin</code>.</p>
<div class="sourceCode" id="cb271"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">weather</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(year, month, day, hour, origin)`</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 18</span></span>
<span><span class="co">#&gt;    year month   day  hour origin dest  tailnum carrier  temp  dewp humid wind_…¹</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1     5 EWR    IAH   N14228  UA       39.0  28.0  64.4     260</span></span>
<span><span class="co">#&gt; 2  2013     1     1     5 LGA    IAH   N24211  UA       39.9  25.0  54.8     250</span></span>
<span><span class="co">#&gt; 3  2013     1     1     5 JFK    MIA   N619AA  AA       39.0  27.0  61.6     260</span></span>
<span><span class="co">#&gt; 4  2013     1     1     5 JFK    BQN   N804JB  B6       39.0  27.0  61.6     260</span></span>
<span><span class="co">#&gt; 5  2013     1     1     6 LGA    ATL   N668DN  DL       39.9  25.0  54.8     260</span></span>
<span><span class="co">#&gt; 6  2013     1     1     5 EWR    ORD   N39463  UA       39.0  28.0  64.4     260</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 6 more variables: wind_speed &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   wind_gust &lt;dbl&gt;, precip &lt;dbl&gt;, pressure &lt;dbl&gt;, visib &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   time_hour &lt;dttm&gt;, and abbreviated variable name ¹​wind_dir</span></span></code></pre></div>
</li>
<li>
<p>Un vettore di caratteri, <code>by = "x"</code>. Questo è come un join naturale, ma usa solo
alcune delle variabili comuni. Per esempio, <code>flights</code> e <code>planes</code> hanno
variabili <code>year</code>, ma significano cose diverse, quindi vogliamo unire solo per
<code>tailnum</code>.</p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">planes</span>, by <span class="op">=</span> <span class="st">"tailnum"</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 16</span></span>
<span><span class="co">#&gt;   year.x month   day  hour origin dest  tailnum carrier year.y type      manuf…¹</span></span>
<span><span class="co">#&gt;    &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1   2013     1     1     5 EWR    IAH   N14228  UA        1999 Fixed wi… BOEING </span></span>
<span><span class="co">#&gt; 2   2013     1     1     5 LGA    IAH   N24211  UA        1998 Fixed wi… BOEING </span></span>
<span><span class="co">#&gt; 3   2013     1     1     5 JFK    MIA   N619AA  AA        1990 Fixed wi… BOEING </span></span>
<span><span class="co">#&gt; 4   2013     1     1     5 JFK    BQN   N804JB  B6        2012 Fixed wi… AIRBUS </span></span>
<span><span class="co">#&gt; 5   2013     1     1     6 LGA    ATL   N668DN  DL        1991 Fixed wi… BOEING </span></span>
<span><span class="co">#&gt; 6   2013     1     1     5 EWR    ORD   N39463  UA        2012 Fixed wi… BOEING </span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, 5 more variables: model &lt;chr&gt;, engines &lt;int&gt;,</span></span>
<span><span class="co">#&gt; #   seats &lt;int&gt;, speed &lt;int&gt;, engine &lt;chr&gt;, and abbreviated variable name</span></span>
<span><span class="co">#&gt; #   ¹​manufacturer</span></span></code></pre></div>
<p>Si noti che le variabili <code>year</code> (che appaiono in entrambi i data frame di input,
ma non sono costrette ad essere uguali) sono disambiguate nell’output con
un suffisso.</p>
</li>
<li>
<p>Un vettore di caratteri con nome: <code>by = c("a" = "b")</code>. Questo
corrisponde alla variabile <code>a</code> nella tabella <code>x</code> alla variabile <code>b</code> nella tabella <code>y</code>. Le
variabili da <code>x</code> saranno usate nell’output.</p>
<p>Per esempio, se vogliamo disegnare una mappa abbiamo bisogno di combinare i dati dei voli
con i dati degli aeroporti che contengono la posizione (<code>lat</code> e <code>lon</code>) di
ogni aeroporto. Ogni volo ha un <code>airport</code> di origine e uno di destinazione, quindi
bisogno di specificare a quale vogliamo unire i dati:</p>
<div class="sourceCode" id="cb273"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"dest"</span> <span class="op">=</span> <span class="st">"faa"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 15</span></span>
<span><span class="co">#&gt;    year month   day  hour origin dest  tailnum carrier name      lat   lon   alt</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1     5 EWR    IAH   N14228  UA      George…  30.0 -95.3    97</span></span>
<span><span class="co">#&gt; 2  2013     1     1     5 LGA    IAH   N24211  UA      George…  30.0 -95.3    97</span></span>
<span><span class="co">#&gt; 3  2013     1     1     5 JFK    MIA   N619AA  AA      Miami …  25.8 -80.3     8</span></span>
<span><span class="co">#&gt; 4  2013     1     1     5 JFK    BQN   N804JB  B6      &lt;NA&gt;     NA    NA      NA</span></span>
<span><span class="co">#&gt; 5  2013     1     1     6 LGA    ATL   N668DN  DL      Hartsf…  33.6 -84.4  1026</span></span>
<span><span class="co">#&gt; 6  2013     1     1     5 EWR    ORD   N39463  UA      Chicag…  42.0 -87.9   668</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, and 3 more variables: tz &lt;dbl&gt;, dst &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   tzone &lt;chr&gt;</span></span>
<span></span>
<span><span class="va">flights2</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">airports</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"origin"</span> <span class="op">=</span> <span class="st">"faa"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 336,776 × 15</span></span>
<span><span class="co">#&gt;    year month   day  hour origin dest  tailnum carrier name      lat   lon   alt</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  2013     1     1     5 EWR    IAH   N14228  UA      Newark…  40.7 -74.2    18</span></span>
<span><span class="co">#&gt; 2  2013     1     1     5 LGA    IAH   N24211  UA      La Gua…  40.8 -73.9    22</span></span>
<span><span class="co">#&gt; 3  2013     1     1     5 JFK    MIA   N619AA  AA      John F…  40.6 -73.8    13</span></span>
<span><span class="co">#&gt; 4  2013     1     1     5 JFK    BQN   N804JB  B6      John F…  40.6 -73.8    13</span></span>
<span><span class="co">#&gt; 5  2013     1     1     6 LGA    ATL   N668DN  DL      La Gua…  40.8 -73.9    22</span></span>
<span><span class="co">#&gt; 6  2013     1     1     5 EWR    ORD   N39463  UA      Newark…  40.7 -74.2    18</span></span>
<span><span class="co">#&gt; # … with 336,770 more rows, and 3 more variables: tz &lt;dbl&gt;, dst &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   tzone &lt;chr&gt;</span></span></code></pre></div>
</li>
</ul>
</div>
<div id="esercizi-30" class="section level3" number="13.4.6">
<h3>
<span class="header-section-number">13.4.6</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-30"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li>
<p>Calcola il ritardo medio per destinazione, poi unisciti al data frame <code>airport</code> in modo da poter mostrare la distribuzione spaziale dei ritardi. Ecco un modo semplice per disegnare una mappa degli Stati Uniti:</p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">airports</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">flights</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"faa"</span> <span class="op">=</span> <span class="st">"dest"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">lon</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/borders.html">borders</a></span><span class="op">(</span><span class="st">"state"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_map.html">coord_quickmap</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>(Non preoccupatevi se non capite cosa fa <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join()</a></code> — lo imparerete
imparerete dopo).</p>
<p>Potreste voler usare la <code>dimensione</code> o il <code>colore</code> dei punti per visualizzare
il ritardo medio per ogni aeroporto.</p>
</li>
<li><p>Aggiungi la posizione dell’origine <em>e</em> della destinazione (cioè la <code>lat</code> e la <code>lon</code>)
a <code>flights</code>.</p></li>
<li><p>Esiste una relazione tra l’età di un aereo e i suoi ritardi?</p></li>
<li><p>Quali condizioni meteorologiche rendono più probabile un ritardo?</p></li>
<li><p>Cosa è successo il 13 giugno 2013? Visualizza lo schema spaziale dei ritardi,
e poi usa Google per fare un riferimento incrociato con le condizionir.</p></li>
</ol>
</div>
<div id="altre-implementazioni" class="section level3" number="13.4.7">
<h3>
<span class="header-section-number">13.4.7</span> Altre implementazioni<a class="anchor" aria-label="anchor" href="#altre-implementazioni"><i class="fas fa-link"></i></a>
</h3>
<p><code><a href="https://rdrr.io/r/base/merge.html">base::merge()</a></code> può eseguire tutti e quattro i tipi di mutating join:</p>
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th>dplyr</th>
<th>merge</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>inner_join(x, y)</code></td>
<td><code>merge(x, y)</code></td>
</tr>
<tr class="even">
<td><code>left_join(x, y)</code></td>
<td><code>merge(x, y, all.x = TRUE)</code></td>
</tr>
<tr class="odd">
<td><code>right_join(x, y)</code></td>
<td>
<code>merge(x, y, all.y = TRUE)</code>,</td>
</tr>
<tr class="even">
<td><code>full_join(x, y)</code></td>
<td><code>merge(x, y, all.x = TRUE, all.y = TRUE)</code></td>
</tr>
</tbody>
</table></div>
<p>Il vantaggio dei verbi specifici di dplyr è che trasmettono più chiaramente l’intento del vostro codice: la differenza tra i join è davvero importante ma nascosta negli argomenti di <code><a href="https://rdrr.io/r/base/merge.html">merge()</a></code>. I join di dplyr sono considerevolmente più veloci e non incasinano l’ordine delle righe.</p>
<p>SQL è l’ispirazione per le convenzioni di dplyr, quindi la traduzione è semplice:</p>
<div class="inline-table"><table class="table table-sm">
<colgroup>
<col width="40%">
<col width="59%">
</colgroup>
<thead><tr class="header">
<th>dplyr</th>
<th>SQL</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>inner_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x INNER JOIN y USING (z)</code></td>
</tr>
<tr class="even">
<td><code>left_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x LEFT OUTER JOIN y USING (z)</code></td>
</tr>
<tr class="odd">
<td><code>right_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x RIGHT OUTER JOIN y USING (z)</code></td>
</tr>
<tr class="even">
<td><code>full_join(x, y, by = "z")</code></td>
<td><code>SELECT * FROM x FULL OUTER JOIN y USING (z)</code></td>
</tr>
</tbody>
</table></div>
<p>Si noti che “INNER” e “OUTER” sono opzionali, e spesso omessi.</p>
<p>Unire diverse variabili tra le tabelle, per esempio <code>inner_join(x, y, by = c("a" = "b"))</code> usa una sintassi leggermente diversa in SQL: <code>SELECT * FROM x INNER JOIN y ON x.a = y.b</code>. Come suggerisce questa sintassi, SQL supporta una gamma più ampia di tipi di join rispetto a dplyr perché è possibile collegare le tabelle usando vincoli diversi dall’uguaglianza (a volte chiamati non-equijoin).</p>
</div>
</div>
<div id="filtering-joins" class="section level2" number="13.5">
<h2>
<span class="header-section-number">13.5</span> Filtering joins<a class="anchor" aria-label="anchor" href="#filtering-joins"><i class="fas fa-link"></i></a>
</h2>
<p>Le filtering joins fanno corrispondere le osservazioni allo stesso modo delle mutating joins, ma influenzano le osservazioni, non le variabili. Ne esistono due tipi:</p>
<ul>
<li>
<code>semi_join(x, y)</code> <strong>tiene</strong> tutte le osservazioni in <code>x</code> che hanno una corrispondenza in <code>y</code>.</li>
<li>
<code>anti_join(x, y)</code> <strong>drops</strong> tutte le osservazioni in <code>x</code> che hanno una corrispondenza in <code>y</code>.</li>
</ul>
<p>Le semi-join sono utili per far corrispondere tabelle di riepilogo filtrate alle righe originali. Per esempio, immaginate di aver trovato le prime dieci destinazioni più popolari:</p>
<div class="sourceCode" id="cb275"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">top_dest</span> <span class="op">&lt;-</span> <span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">dest</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">top_dest</span></span>
<span><span class="co">#&gt; # A tibble: 10 × 2</span></span>
<span><span class="co">#&gt;   dest      n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 ORD   17283</span></span>
<span><span class="co">#&gt; 2 ATL   17215</span></span>
<span><span class="co">#&gt; 3 LAX   16174</span></span>
<span><span class="co">#&gt; 4 BOS   15508</span></span>
<span><span class="co">#&gt; 5 MCO   14082</span></span>
<span><span class="co">#&gt; 6 CLT   14064</span></span>
<span><span class="co">#&gt; # … with 4 more rows</span></span></code></pre></div>
<p>Ora vuoi trovare ogni volo che è andato a una di queste destinazioni. Potresti costruire tu stesso un filtro:</p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dest</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">top_dest</span><span class="op">$</span><span class="va">dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 141,145 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      555         600      -5     913     854      19 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      557         600      -3     838     846      -8 B6     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      558         600      -2     753     745       8 AA     </span></span>
<span><span class="co">#&gt; # … with 141,139 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>Ma è difficile estendere questo approccio a più variabili. Per esempio, immagina di aver trovato i 10 giorni con i più alti ritardi medi. Come costruireste la dichiarazione del filtro che usa <code>year</code>, <code>month</code> e <code>day</code> per abbinarlo a <code>flight</code>?</p>
<p>Invece puoi usare una semi-join, che collega le due tabelle come una mutating join, ma invece di aggiungere nuove colonne, mantiene solo le righe in <code>x</code> che hanno una corrispondenza in <code>y</code>:</p>
<div class="sourceCode" id="cb277"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">semi_join</a></span><span class="op">(</span><span class="va">top_dest</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(dest)`</span></span>
<span><span class="co">#&gt; # A tibble: 141,145 × 19</span></span>
<span><span class="co">#&gt;    year month   day dep_time sched_dep…¹ dep_d…² arr_t…³ sched…⁴ arr_d…⁵ carrier</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;       &lt;int&gt;   &lt;dbl&gt;   &lt;int&gt;   &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  </span></span>
<span><span class="co">#&gt; 1  2013     1     1      542         540       2     923     850      33 AA     </span></span>
<span><span class="co">#&gt; 2  2013     1     1      554         600      -6     812     837     -25 DL     </span></span>
<span><span class="co">#&gt; 3  2013     1     1      554         558      -4     740     728      12 UA     </span></span>
<span><span class="co">#&gt; 4  2013     1     1      555         600      -5     913     854      19 B6     </span></span>
<span><span class="co">#&gt; 5  2013     1     1      557         600      -3     838     846      -8 B6     </span></span>
<span><span class="co">#&gt; 6  2013     1     1      558         600      -2     753     745       8 AA     </span></span>
<span><span class="co">#&gt; # … with 141,139 more rows, 9 more variables: flight &lt;int&gt;, tailnum &lt;chr&gt;,</span></span>
<span><span class="co">#&gt; #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,</span></span>
<span><span class="co">#&gt; #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, and abbreviated variable names</span></span>
<span><span class="co">#&gt; #   ¹​sched_dep_time, ²​dep_delay, ³​arr_time, ⁴​sched_arr_time, ⁵​arr_delay</span></span></code></pre></div>
<p>Graficamente, una semi-unione appare così:</p>
<div class="inline-figure"><img src="diagrams/join-semi.png" width="307" style="display: block; margin: auto;"></div>
<p>Solo l’esistenza di una corrispondenza è importante; non ha importanza quale osservazione viene abbinata. Questo significa che i filtering joins non duplicano mai le righe come fanno i mutating joins:</p>
<div class="inline-figure"><img src="diagrams/join-semi-many.png" width="312" style="display: block; margin: auto;"></div>
<p>L’inverso di una semi-join è un anti-join. Un anti-join mantiene le righe che <em>non</em> hanno una corrispondenza:</p>
<div class="inline-figure"><img src="diagrams/join-anti.png" width="307" style="display: block; margin: auto;"></div>
<p>Gli anti-join sono utili per diagnosticare le mancate corrispondenze. Per esempio, quando si collegano <code>flights</code> e <code>planes</code>, si potrebbe essere interessati a sapere che ci sono molti <code>flights</code> che non hanno una corrispondenza in <code>planes</code>:</p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">flights</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join</a></span><span class="op">(</span><span class="va">planes</span>, by <span class="op">=</span> <span class="st">"tailnum"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">tailnum</span>, sort <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 722 × 2</span></span>
<span><span class="co">#&gt;   tailnum     n</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1 &lt;NA&gt;     2512</span></span>
<span><span class="co">#&gt; 2 N725MQ    575</span></span>
<span><span class="co">#&gt; 3 N722MQ    513</span></span>
<span><span class="co">#&gt; 4 N723MQ    507</span></span>
<span><span class="co">#&gt; 5 N713MQ    483</span></span>
<span><span class="co">#&gt; 6 N735MQ    396</span></span>
<span><span class="co">#&gt; # … with 716 more rows</span></span></code></pre></div>
<div id="esercizi-31" class="section level3" number="13.5.1">
<h3>
<span class="header-section-number">13.5.1</span> Esercizi<a class="anchor" aria-label="anchor" href="#esercizi-31"><i class="fas fa-link"></i></a>
</h3>
<ol style="list-style-type: decimal">
<li><p>Cosa significa che un volo ha un <code>tailnum</code> mancante? Cosa hanno in comune i
numeri di coda che non hanno un record corrispondente in <code>planes</code> hanno in comune?
(Suggerimento: una variabile spiega il ~90% dei problemi).</p></li>
<li><p>Filtra i voli per mostrare solo i voli con aerei che hanno volato almeno 100
voli.</p></li>
<li><p>Combina <code>fueleconomy::vehicles</code> e <code>fueleconomy::common</code> per trovare solo i
record per i modelli più comuni.</p></li>
<li><p>Trova le 48 ore (nel corso dell’intero anno) che hanno i peggiori
ritardi. Fai un riferimento incrociato con i dati <code>weather</code>. Puoi vedere qualche
modelli?</p></li>
<li>
<p>Cosa ti dice <code>anti_join(flights, airports, by = c("dest" = "faa"))</code>?</p>
<ol start="2" style="list-style-type: decimal">
<li>Che cosa ti dice <code>anti_join(airports, flights, by = c("faa" = "dest"))</code>?</li>
</ol>
</li>
<li><p>Ci si potrebbe aspettare che ci sia una relazione implicita tra aereo
e compagnia aerea, perché ogni aereo è pilotato da una sola compagnia aerea. Confermate
o rifiutare questa ipotesi usando gli strumenti che hai imparato sopra.</p></li>
</ol>
</div>
</div>
<div id="problemi-di-join" class="section level2" number="13.6">
<h2>
<span class="header-section-number">13.6</span> Problemi di join<a class="anchor" aria-label="anchor" href="#problemi-di-join"><i class="fas fa-link"></i></a>
</h2>
<p>I dati con cui avete lavorato in questo capitolo sono stati puliti in modo che abbiate meno problemi possibili. E’ improbabile che i vostri dati siano così belli, quindi ci sono alcune cose che dovreste fare con i vostri dati per far sì che le vostre unioni vadano lisce.</p>
<ol style="list-style-type: decimal">
<li>
<p>Iniziate identificando le variabili che formano la chiave primaria in ogni tabella.
Di solito dovreste farlo basandovi sulla vostra comprensione dei dati, non
empiricamente cercando una combinazione di variabili che dia un
identificatore unico. Se cercate solo le variabili senza pensare a
al loro significato, potreste essere (dis)fortunati e trovare una combinazione che è
unica nei vostri dati attuali, ma la relazione potrebbe non essere vera in
generale.</p>
<p>Per esempio, l’altitudine e la longitudine identificano in modo unico ogni aeroporto,
ma non sono buoni identificatori!</p>
<div class="sourceCode" id="cb279"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">airports</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html">count</a></span><span class="op">(</span><span class="va">alt</span>, <span class="va">lon</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 0 × 3</span></span>
<span><span class="co">#&gt; # … with 3 variables: alt &lt;dbl&gt;, lon &lt;dbl&gt;, n &lt;int&gt;</span></span></code></pre></div>
</li>
<li><p>Controllare che nessuna delle variabili della chiave primaria sia mancante. Se
un valore è mancante allora non può identificare un’osservazione!</p></li>
<li>
<p>Controlla che le tue chiavi esterne corrispondano alle chiavi primarie di un’altra tabella. Il
modo migliore per farlo è con un <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join()</a></code>. È comune che le chiavi
non corrispondano a causa di errori nell’inserimento dei dati. Correggere questi errori è spesso un sacco di
lavoro.</p>
<p>Se avete delle chiavi mancanti, dovrete essere attenti all’uso
l’uso delle unioni interne rispetto a quelle esterne, valutando attentamente se
se volete eliminare le righe che non hanno una corrispondenza.</p>
</li>
</ol>
<p>Siate consapevoli che controllare semplicemente il numero di righe prima e dopo l’unione non è sufficiente ad assicurare che la vostra unione sia andata bene. Se hai un join interno con chiavi duplicate in entrambe le tabelle, potresti essere sfortunato perché il numero di righe eliminate potrebbe essere esattamente uguale al numero di righe duplicate!</p>
</div>
<div id="set-operations" class="section level2" number="13.7">
<h2>
<span class="header-section-number">13.7</span> Operazioni di set<a class="anchor" aria-label="anchor" href="#set-operations"><i class="fas fa-link"></i></a>
</h2>
<p>L’ultimo tipo di verbo di due tabelle sono le operazioni di set. Generalmente sono quelle che uso meno frequentemente, ma sono occasionalmente utili quando si vuole spezzare un singolo filtro complesso in pezzi più semplici. Tutte queste operazioni lavorano con una riga completa, confrontando i valori di ogni variabile. Queste si aspettano che gli input <code>x</code> e <code>y</code> abbiano le stesse variabili, e trattano le osservazioni come insiemi:</p>
<ul>
<li>
<code>intersect(x, y)</code>: restituisce solo le osservazioni sia in <code>x</code> che in <code>y</code>.</li>
<li>
<code>union(x, y)</code>: restituisce osservazioni uniche in <code>x</code> e <code>y</code>.</li>
<li>
<code>setdiff(x, y)</code>: restituisce le osservazioni in <code>x</code>, ma non in <code>y</code>.</li>
</ul>
<p>Dati questi semplici dati:</p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,</span>
<span>   <span class="fl">1</span>,  <span class="fl">1</span>,</span>
<span>   <span class="fl">2</span>,  <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,</span>
<span>   <span class="fl">1</span>,  <span class="fl">1</span>,</span>
<span>   <span class="fl">1</span>,  <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Le quattro possibilità sono:</p>
<div class="sourceCode" id="cb281"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">intersect</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1     1</span></span>
<span></span>
<span><span class="co"># Notate che otteniamo 3 righe, non 4</span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">union</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 3 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1     1</span></span>
<span><span class="co">#&gt; 2     2     1</span></span>
<span><span class="co">#&gt; 3     1     2</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     2     1</span></span>
<span></span>
<span><span class="fu"><a href="https://generics.r-lib.org/reference/setops.html">setdiff</a></span><span class="op">(</span><span class="va">df2</span>, <span class="va">df1</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;       x     y</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1     1     2</span></span></code></pre></div>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="tidy-data.html"><span class="header-section-number">12</span> Tidy data</a></div>
<div class="next"><a href="stringhe.html"><span class="header-section-number">14</span> Stringhe</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#dati-relazionali"><span class="header-section-number">13</span> Dati relazionali</a></li>
<li>
<a class="nav-link" href="#introduzione-7"><span class="header-section-number">13.1</span> Introduzione</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#prerequisiti-7"><span class="header-section-number">13.1.1</span> Prerequisiti</a></li></ul>
</li>
<li>
<a class="nav-link" href="#nycflights13-relational"><span class="header-section-number">13.2</span> nycflights13</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#esercizi-28"><span class="header-section-number">13.2.1</span> Esercizi</a></li></ul>
</li>
<li>
<a class="nav-link" href="#chiavi"><span class="header-section-number">13.3</span> Chiavi</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#esercizi-29"><span class="header-section-number">13.3.1</span> Esercizi</a></li></ul>
</li>
<li>
<a class="nav-link" href="#mutating-joins"><span class="header-section-number">13.4</span> Mutating joins</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#capire-le-unioni"><span class="header-section-number">13.4.1</span> Capire le unioni</a></li>
<li><a class="nav-link" href="#inner-join"><span class="header-section-number">13.4.2</span> Inner join</a></li>
<li><a class="nav-link" href="#outer-join"><span class="header-section-number">13.4.3</span> Outer joins</a></li>
<li><a class="nav-link" href="#join-matches"><span class="header-section-number">13.4.4</span> Chiavi duplicate</a></li>
<li><a class="nav-link" href="#join-by"><span class="header-section-number">13.4.5</span> Definizione delle colonne chiave</a></li>
<li><a class="nav-link" href="#esercizi-30"><span class="header-section-number">13.4.6</span> Esercizi</a></li>
<li><a class="nav-link" href="#altre-implementazioni"><span class="header-section-number">13.4.7</span> Altre implementazioni</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#filtering-joins"><span class="header-section-number">13.5</span> Filtering joins</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#esercizi-31"><span class="header-section-number">13.5.1</span> Esercizi</a></li></ul>
</li>
<li><a class="nav-link" href="#problemi-di-join"><span class="header-section-number">13.6</span> Problemi di join</a></li>
<li><a class="nav-link" href="#set-operations"><span class="header-section-number">13.7</span> Operazioni di set</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/lucavd/r4ds_ita_1st_ed/blob/master/relational-data.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/lucavd/r4ds_ita_1st_ed/edit/master/relational-data.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>R for Data Science - edizione italiana</strong>" was written by Hadley Wickham e Garrett Grolemund. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
